<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ZG — Zoot Games | Play & Earn Crypto</title>
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#00d4aa" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="ZG" />
  <link rel="apple-touch-icon" href="/icons/icon-192.svg" />
  <meta name="description" content="Play Domino, Tic Tac Toe, Mancala, Checkers, Chess — bet Solana crypto and win!" />
  <link rel="icon" type="image/svg+xml" href="/icons/icon-192.svg" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0b0f19;
      --bg2: #0f1623;
      --surface: #151f32;
      --surface2: #1e2d44;
      --accent: #00d4aa;
      --accent2: #33e8c0;
      --green: #00c853;
      --red: #ff3d57;
      --gold: #ffc107;
      --text: #e8ecf1;
      --text2: #7a8ba5;
      --radius: 12px;
      --radius-sm: 8px;
      --felt: #1a5c3a;
      --felt2: #14472d;
      --glow: rgba(0,212,170,0.15);
      --glow-gold: rgba(255,193,7,0.12);
    }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
      background-image:
        radial-gradient(ellipse at 20% 0%, rgba(0,212,170,0.04) 0%, transparent 60%),
        radial-gradient(ellipse at 80% 100%, rgba(255,193,7,0.03) 0%, transparent 60%);
    }

    .screen { display: none; min-height: 100vh; }
    .screen.active { display: flex; }

    #screen-connect {
      align-items: center;
      justify-content: center;
      background: #060a12;
      position: relative; overflow: hidden;
    }
    .video-bg {
      position: absolute; inset: 0; width: 100%; height: 100%;
      object-fit: cover; opacity: 0.35; pointer-events: none; z-index: 0;
    }
    #screen-connect::before {
      content: ''; position: absolute; inset: 0; z-index: 1;
      background:
        linear-gradient(180deg, rgba(6,10,18,0.7) 0%, rgba(6,10,18,0.3) 40%, rgba(6,10,18,0.8) 100%);
      pointer-events: none;
    }
    .connect-container { text-align: center; max-width: 520px; padding: 2rem; position: relative; z-index: 2; }
    .logo { margin-bottom: 0.5rem; }
    .logo-mark {
      display: inline-block; overflow: hidden;
      width: 88px; height: 88px; border-radius: 22px;
      background: linear-gradient(135deg, #00d4aa, #00897b);
      margin-bottom: 1rem;
      box-shadow: 0 8px 40px rgba(0,212,170,0.3), 0 0 80px rgba(0,212,170,0.1);
      animation: logoPulse 3s ease-in-out infinite;
    }
    @keyframes logoPulse { 0%,100%{box-shadow:0 8px 40px rgba(0,212,170,0.3),0 0 80px rgba(0,212,170,0.1)} 50%{box-shadow:0 8px 50px rgba(0,212,170,0.45),0 0 100px rgba(0,212,170,0.15)} }
    .logo h1 { font-size: 2.6rem; font-weight: 800; letter-spacing: -1px; }
    .accent { color: var(--accent); }
    .logo-subtitle { font-size: 0.85rem; color: var(--gold); font-weight: 600; letter-spacing: 4px; text-transform: uppercase; margin-top: 0.4rem; }
    .tagline { font-size: 1.15rem; color: var(--text2); margin-bottom: 1.5rem; margin-top: 0.8rem; line-height: 1.6; }
    .connect-stats {
      display: flex; justify-content: center; gap: 1rem; margin-bottom: 2rem;
    }
    .stat-pill {
      background: rgba(21,31,50,0.8); border: 1px solid var(--surface2); border-radius: 10px;
      padding: 0.7rem 1.2rem; display: flex; flex-direction: column; align-items: center; gap: 0.15rem;
      min-width: 80px;
    }
    .stat-value { font-size: 1.2rem; font-weight: 800; color: var(--accent); }
    .stat-label { font-size: 0.65rem; color: var(--text2); text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
    .connect-form { display: flex; flex-direction: column; gap: 1rem; }

    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
      border: none; border-radius: var(--radius); font-family: inherit; font-weight: 600;
      cursor: pointer; transition: all 0.2s; padding: 0.7rem 1.4rem; font-size: 0.95rem;
    }
    .btn-primary { background: linear-gradient(135deg, var(--accent), #00897b); color: #fff; }
    .btn-primary:hover { background: linear-gradient(135deg, var(--accent2), var(--accent)); transform: translateY(-1px); box-shadow: 0 4px 20px rgba(0,212,170,0.25); }
    .btn-danger { background: var(--red); color: #fff; }
    .btn-danger:hover { opacity: 0.85; }
    .btn-lg { padding: 1rem 1.8rem; font-size: 1.1rem; }
    .small-text { color: var(--text2); font-size: 0.8rem; margin-top: 0.5rem; }

    .btn-phantom {
      background: linear-gradient(135deg, #ab9ff2, #6e56cf);
      color: #fff; border: none; border-radius: var(--radius);
      padding: 1rem 1.8rem; font-size: 1.1rem; font-weight: 700; font-family: inherit;
      cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.7rem;
      transition: all 0.25s; width: 100%;
      box-shadow: 0 4px 24px rgba(110,86,207,0.35);
      position: relative; overflow: hidden;
    }
    .btn-phantom::after {
      content: ''; position: absolute; top: -50%; left: -60%; width: 60%; height: 200%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.08), transparent);
      transform: rotate(25deg); transition: left 0.6s;
    }
    .btn-phantom:hover::after { left: 120%; }
    .btn-phantom:hover { transform: translateY(-2px); box-shadow: 0 6px 32px rgba(110,86,207,0.5); }
    .btn-phantom:disabled { opacity: 0.6; cursor: default; transform: none; }
    .btn-phantom img { width: 24px; height: 24px; }

    .topbar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0.7rem 1.5rem; background: rgba(15,22,35,0.95);
      border-bottom: 1px solid rgba(30,45,68,0.6); position: sticky; top: 0; z-index: 100;
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    }
    .topbar-left, .topbar-center, .topbar-right { display: flex; align-items: center; gap: 0.7rem; }
    .logo-sm { font-weight: 800; font-size: 1.1rem; display: flex; align-items: center; gap: 0.4rem; }
    .logo-sm-mark {
      display: inline-flex; align-items: center; justify-content: center;
      width: 30px; height: 30px; border-radius: 7px;
      background: linear-gradient(135deg, #00d4aa, #00897b);
      font-size: 0.75rem; font-weight: 800; color: #fff; letter-spacing: -1px;
    }
    .badge {
      background: var(--surface); padding: 0.3rem 0.7rem; border-radius: 999px;
      font-size: 0.8rem; color: var(--text2); border: 1px solid var(--surface2);
    }
    .badge-live {
      position: relative; padding-left: 1.4rem;
    }
    .badge-live::before {
      content: ''; position: absolute; left: 0.5rem; top: 50%; transform: translateY(-50%);
      width: 7px; height: 7px; border-radius: 50%; background: var(--green);
      box-shadow: 0 0 8px var(--green);
      animation: livePulse 2s ease-in-out infinite;
    }
    @keyframes livePulse { 0%,100%{opacity:1;box-shadow:0 0 8px var(--green)} 50%{opacity:0.5;box-shadow:0 0 14px var(--green)} }
    .wallet-badge {
      background: var(--surface); padding: 0.3rem 0.7rem; border-radius: 999px;
      font-size: 0.75rem; color: var(--accent2); font-family: monospace;
      border: 1px solid var(--surface2);
    }

    #screen-lobby { flex-direction: column; }
    .lobby-main { max-width: 1060px; margin: 0 auto; padding: 2rem 1.5rem; width: 100%; }
    .lobby-main > h2 {
      font-size: 1.4rem; margin-bottom: 1.2rem; font-weight: 700;
      display: flex; align-items: center; gap: 0.6rem;
      text-transform: uppercase; letter-spacing: 1px; font-size: 0.95rem; color: var(--text2);
    }
    .lobby-main > h2::before {
      content: ''; display: inline-block; width: 4px; height: 20px;
      background: var(--accent); border-radius: 2px;
    }
    .game-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; margin-bottom: 2.5rem; }
    .game-card {
      background: linear-gradient(135deg, var(--bg2), var(--surface));
      border: 1px solid var(--surface2); border-radius: var(--radius);
      padding: 1.5rem 1.5rem 1.3rem; transition: all 0.25s;
      position: relative; overflow: hidden;
      background-size: cover; background-position: center;
    }
    .game-card::before {
      content: ''; position: absolute; inset: 0;
      background: linear-gradient(180deg, rgba(11,15,25,0.35) 0%, rgba(11,15,25,0.75) 100%);
      z-index: 0; transition: all 0.25s;
    }
    .game-card > * { position: relative; z-index: 1; }
    .game-card:hover { border-color: var(--accent); transform: translateY(-3px); box-shadow: 0 8px 30px rgba(0,0,0,0.3); }
    .game-card:hover::before { background: linear-gradient(180deg, rgba(11,15,25,0.2) 0%, rgba(11,15,25,0.7) 100%); }
    .game-card[data-game="domino"] { background-image: url('/game-domino.jpg'); }
    .game-card[data-game="domino"] .btn-play { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    .game-card[data-game="tictactoe"] { background-image: url('/game-tictactoe.jpg'); }
    .game-card[data-game="tictactoe"] .btn-play { background: linear-gradient(135deg, #3498db, #2980b9); }
    .game-card[data-game="mancala"] { background-image: url('/game-mancala.jpg'); }
    .game-card[data-game="mancala"] .btn-play { background: linear-gradient(135deg, #f39c12, #e67e22); }
    .game-card[data-game="checkers"] { background-image: url('/game-checkers.jpg'); }
    .game-card[data-game="checkers"] .btn-play { background: linear-gradient(135deg, #e84393, #d63384); }
    .game-card[data-game="chess"] { background-image: url('/game-chess.jpg'); }
    .game-card[data-game="chess"] .btn-play { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
    .game-card[data-game="morpion"] { background-image: url('/game-morpion.jpg'); }
    .game-card[data-game="morpion"] .btn-play { background: linear-gradient(135deg, #00d4aa, #00897b); }
    .game-card-header { display: flex; align-items: center; gap: 0.8rem; margin-bottom: 0.8rem; }
    .game-card-icon { font-size: 2.2rem; flex-shrink: 0; }
    .game-card h3 { font-size: 1.15rem; margin-bottom: 0; }
    .game-card p { color: var(--text2); font-size: 0.82rem; margin-bottom: 1rem; line-height: 1.5; }
    .game-card .multiplier-badge {
      display: inline-block; background: rgba(0,212,170,0.1); color: var(--accent);
      padding: 0.2rem 0.6rem; border-radius: 999px; font-size: 0.7rem; font-weight: 700;
      margin-bottom: 0.8rem; border: 1px solid rgba(0,212,170,0.2);
    }
    .game-card.coming-soon {
      opacity: 0.7; pointer-events: none; position: relative;
    }
    .game-card.coming-soon::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
      background: linear-gradient(90deg, var(--gold), #ff9800); opacity: 1;
    }
    .game-card.coming-soon::after {
      content: 'COMING SOON'; position: absolute; top: 12px; right: 12px;
      background: var(--gold); color: #000; font-size: 0.6rem; font-weight: 800;
      padding: 0.2rem 0.5rem; border-radius: 4px; letter-spacing: 1px;
    }
    .badge-house {
      display: inline-block; background: rgba(255,193,7,0.1); color: var(--gold);
      padding: 0.2rem 0.6rem; border-radius: 999px; font-size: 0.65rem; font-weight: 700;
      border: 1px solid rgba(255,193,7,0.2); margin-left: 0.3rem;
    }
    .badge-zootcoin {
      display: inline-flex; align-items: center; gap: 0.3rem;
      background: linear-gradient(135deg, rgba(255,193,7,0.12), rgba(255,152,0,0.08));
      color: var(--gold); padding: 0.2rem 0.6rem; border-radius: 999px;
      font-size: 0.65rem; font-weight: 700; border: 1px solid rgba(255,193,7,0.2);
    }
    .zootcoin-banner {
      background: linear-gradient(135deg, rgba(255,193,7,0.06), rgba(255,152,0,0.03));
      border: 1px solid rgba(255,193,7,0.15); border-radius: var(--radius);
      padding: 1.2rem 1.5rem; margin-bottom: 2rem; display: flex; align-items: center; gap: 1rem;
    }
    .zootcoin-banner-icon { font-size: 2rem; flex-shrink: 0; }
    .zootcoin-banner-text { flex: 1; }
    .zootcoin-banner-text h3 {
      font-size: 0.95rem; font-weight: 800; color: var(--gold); margin-bottom: 0.2rem;
      display: flex; align-items: center; gap: 0.5rem;
    }
    .zootcoin-banner-text h3 .soon-tag {
      font-size: 0.6rem; background: var(--gold); color: #000; padding: 0.1rem 0.4rem;
      border-radius: 4px; font-weight: 800; letter-spacing: 0.5px;
    }
    .zootcoin-banner-text p { font-size: 0.78rem; color: var(--text2); line-height: 1.5; }
    .grid-options { display: flex; gap: 0.4rem; flex-wrap: wrap; }
    .grid-btn {
      background: var(--surface); border: 2px solid var(--surface2); color: var(--text);
      border-radius: var(--radius-sm); padding: 0.35rem 0.8rem; font-family: inherit;
      font-weight: 600; font-size: 0.82rem; cursor: pointer; transition: all 0.15s;
    }
    .grid-btn:hover { border-color: var(--accent); }
    .grid-btn.active { border-color: var(--accent); background: rgba(0,212,170,0.1); color: var(--accent2); }
    .grid-select { margin-bottom: 0.8rem; }
    .grid-select label { font-size: 0.8rem; color: var(--text2); display: block; margin-bottom: 0.4rem; }
    .btn-play {
      width: 100%; position: relative; overflow: hidden;
      text-transform: uppercase; letter-spacing: 1px; font-size: 0.85rem;
    }
    .btn-play::after {
      content: ''; position: absolute; top: -50%; left: -60%; width: 60%; height: 200%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.07), transparent);
      transform: rotate(25deg); transition: left 0.5s;
    }
    .btn-play:hover::after { left: 120%; }
    .bet-input-group { display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.8rem; }
    .bet-input-group label { font-size: 0.8rem; color: var(--text2); font-weight: 600; }
    .bet-input-group input[type="number"] {
      background: var(--bg); border: 2px solid var(--surface2); border-radius: var(--radius-sm);
      padding: 0.5rem 0.7rem; color: var(--gold); font-family: inherit; font-size: 1rem;
      font-weight: 700; outline: none; width: 110px; transition: border-color 0.2s;
    }
    .bet-input-group input[type="number"]:focus { border-color: var(--gold); box-shadow: 0 0 0 3px var(--glow-gold); }
    .bet-input-group .sol-label { font-size: 0.85rem; color: var(--gold); font-weight: 700; }

    .pending-bets-section {
      margin-bottom: 2.5rem;
      background: linear-gradient(135deg, var(--bg2), rgba(21,31,50,0.6));
      border: 1px solid var(--surface2); border-radius: var(--radius);
      padding: 1.3rem 1.5rem;
    }
    .pending-bets-section h2 {
      font-size: 0.9rem; margin-bottom: 1rem; font-weight: 700; display: flex; align-items: center; gap: 0.6rem;
      text-transform: uppercase; letter-spacing: 1px; color: var(--text2);
    }
    .pending-bets-section h2::before {
      content: ''; display: inline-block; width: 8px; height: 8px; border-radius: 50%;
      background: var(--green); box-shadow: 0 0 8px var(--green);
      animation: livePulse 2s ease-in-out infinite;
    }
    .pending-bets-section h2 .pending-count {
      background: var(--red); color: #fff; font-size: 0.7rem; font-weight: 700;
      padding: 0.12rem 0.5rem; border-radius: 999px; min-width: 20px; text-align: center;
      margin-left: auto;
    }
    .pending-filter { display: flex; gap: 0.35rem; flex-wrap: wrap; margin-bottom: 1rem; padding-bottom: 0.8rem; border-bottom: 1px solid var(--surface2); }
    .pending-filter-btn {
      background: transparent; border: 1px solid var(--surface2); color: var(--text2);
      padding: 0.3rem 0.8rem; border-radius: 6px; cursor: pointer; font-size: 0.78rem;
      font-family: inherit; font-weight: 600; transition: all 0.2s;
    }
    .pending-filter-btn:hover { border-color: var(--accent); color: var(--text); }
    .pending-filter-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }
    .pending-bets-list {
      display: flex; flex-direction: column; gap: 0; max-height: 420px; overflow-y: auto;
    }
    .pending-bets-list::-webkit-scrollbar { width: 4px; }
    .pending-bets-list::-webkit-scrollbar-track { background: transparent; }
    .pending-bets-list::-webkit-scrollbar-thumb { background: var(--surface2); border-radius: 4px; }
    .pending-bet-card {
      background: transparent; border: none; border-bottom: 1px solid rgba(30,45,68,0.5);
      border-radius: 0; padding: 0.7rem 0.5rem; display: flex; align-items: center; gap: 0.8rem;
      transition: background 0.15s; flex-wrap: nowrap;
    }
    .pending-bet-card:hover { background: rgba(0,212,170,0.04); }
    .pending-bet-card:last-child { border-bottom: none; }
    .pending-bet-card.own-bet { opacity: 0.5; }
    .pending-bet-card.own-bet:hover { background: transparent; }
    .pending-bet-icon { font-size: 1.5rem; flex-shrink: 0; width: 36px; text-align: center; }
    .pending-bet-info { flex: 1; min-width: 0; }
    .pending-bet-game { font-weight: 700; font-size: 0.88rem; margin-bottom: 0.1rem; color: var(--text); }
    .pending-bet-player { font-size: 0.75rem; color: var(--text2); display: flex; align-items: center; gap: 0.4rem; }
    .pending-bet-player .wallet-tag {
      background: rgba(0,212,170,0.08); padding: 0.1rem 0.4rem; border-radius: 4px; font-size: 0.65rem;
      font-family: 'Courier New', monospace; color: var(--accent); border: 1px solid rgba(0,212,170,0.15);
    }
    .pending-bet-amount {
      font-size: 1.05rem; font-weight: 800; color: var(--gold); text-align: right;
      flex-shrink: 0; min-width: 80px; display: flex; flex-direction: column; align-items: flex-end;
    }
    .pending-bet-amount small { font-size: 0.65rem; font-weight: 600; color: var(--text2); }
    .pending-bet-accept {
      background: linear-gradient(135deg, var(--accent), #00897b); color: #fff; border: none;
      border-radius: 6px; padding: 0.45rem 1rem; font-family: inherit; font-size: 0.8rem;
      font-weight: 700; cursor: pointer; transition: all 0.2s; flex-shrink: 0;
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    .pending-bet-accept:hover { box-shadow: 0 4px 16px rgba(0,212,170,0.3); transform: scale(1.03); }
    .pending-bet-accept:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
    .pending-bet-accept.own-label {
      background: var(--surface2); color: var(--text2); cursor: default; font-weight: 600;
      text-transform: none; letter-spacing: 0;
    }
    .pending-empty {
      text-align: center; color: var(--text2); padding: 2.5rem 1rem;
      font-size: 0.85rem; opacity: 0.7;
    }

    .live-section { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
    .live-col h4 {
      font-size: 0.8rem; margin-bottom: 0.8rem; color: var(--text2);
      text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 0.5rem;
    }
    .live-col h4::before {
      content: ''; width: 3px; height: 14px; background: var(--gold); border-radius: 2px;
    }
    .activity-list { list-style: none; display: flex; flex-direction: column; gap: 0.3rem; max-height: 200px; overflow-y: auto; }
    .activity-list li {
      background: var(--surface); padding: 0.5rem 0.8rem; border-radius: 6px;
      font-size: 0.82rem; display: flex; justify-content: space-between;
      border: 1px solid transparent; transition: border-color 0.2s;
    }
    .activity-list li:hover { border-color: var(--surface2); }
    .activity-list .empty-msg { color: var(--text2); font-style: italic; }

    #screen-waiting {
      align-items: center; justify-content: center; flex-direction: column;
      background: radial-gradient(ellipse at 50% 40%, rgba(0,212,170,0.05) 0%, var(--bg) 60%);
    }
    .waiting-container { text-align: center; }
    .waiting-container h2 { margin: 1.5rem 0 0.5rem; font-size: 1.3rem; }
    .waiting-container p { color: var(--text2); margin-bottom: 1.5rem; font-size: 0.9rem; }
    .spinner {
      width: 50px; height: 50px; border: 3px solid var(--surface2); border-top-color: var(--accent);
      border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto;
      box-shadow: 0 0 20px rgba(0,212,170,0.1);
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    @keyframes toastIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    #screen-game { flex-direction: column; }
    .game-topbar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0.7rem 1.5rem; background: rgba(15,22,35,0.95); border-bottom: 1px solid var(--surface2);
      flex-wrap: wrap; gap: 0.5rem;
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    }
    .game-info { display: flex; gap: 0.5rem; }
    .badge-game { background: var(--accent); color: #fff; }
    .badge-bet { background: var(--gold); color: #000; font-weight: 700; }
    .game-players { display: flex; align-items: center; gap: 0.5rem; }
    .player-label { font-weight: 600; font-size: 0.9rem; }
    .vs { color: var(--text2); font-size: 0.8rem; }
    .turn-indicator { font-size: 0.9rem; font-weight: 600; padding: 0.3rem 0.8rem; border-radius: 999px; }
    .turn-indicator.my-turn { background: var(--green); color: #fff; }
    .turn-indicator.their-turn { background: var(--surface); color: var(--text2); }
    .game-area { flex: 1; display: block; padding: 0; overflow: hidden; position: relative; }
    .game-controls { background: var(--bg2); border-top: 1px solid var(--surface2); padding: 1rem 1.5rem; min-height: 0; }

    /* ═══ DOMINO — Plato / Domino King exact replica ═══ */
    .domino-screen {
      display: flex; flex-direction: column; position: fixed; inset: 0;
      background: linear-gradient(180deg, #1a3a8a 0%, #2563eb 10%, #3b82f6 50%, #2563eb 90%, #1a3a8a 100%);
      z-index: 10;
    }
    .domino-opp-bar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0.2rem 0.7rem;
      background: linear-gradient(180deg, #0c1d4d 0%, #152d6e 100%);
    }
    .domino-opp-bar .back-btn {
      width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.12);
      border: none; color: #fff; font-size: 1.1rem; cursor: pointer; display: flex;
      align-items: center; justify-content: center;
    }
    .domino-opp-center { display: flex; flex-direction: column; align-items: center; }
    .domino-opp-top-row { display: flex; align-items: center; gap: 0.4rem; }
    .domino-avatar {
      width: 36px; height: 36px; border-radius: 50%; background: #374151;
      display: flex; align-items: center; justify-content: center;
      font-size: 1rem; font-weight: 800; color: #fff;
      border: 2.5px solid #60a5fa; box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .domino-avatar.my { border-color: #22c55e; }
    .domino-score-big { font-size: 1.2rem; font-weight: 800; color: #fff; letter-spacing: -0.5px; }
    .domino-name-row { display: flex; align-items: center; gap: 0.3rem; margin-top: 0.1rem; }
    .domino-online-dot { width: 7px; height: 7px; border-radius: 50%; background: #22c55e; }
    .domino-username { font-size: 0.8rem; font-weight: 600; color: #93c5fd; }
    .domino-menu-btn {
      width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.12);
      border: none; color: #fff; font-size: 1.2rem; cursor: pointer; display: flex;
      align-items: center; justify-content: center; position: relative;
    }
    .domino-dropdown {
      position: absolute; top: 44px; right: 0; background: #1e3a8a; border: 1.5px solid #3b82f6;
      border-radius: 10px; min-width: 140px; box-shadow: 0 8px 24px rgba(0,0,0,0.5); z-index: 100;
      overflow: hidden; display: none;
    }
    .domino-dropdown.open { display: block; }
    .domino-dropdown-item {
      padding: 0.7rem 1rem; color: #fff; font-size: 0.9rem; font-weight: 600; cursor: pointer;
      border: none; background: none; width: 100%; text-align: left; font-family: inherit;
    }
    .domino-dropdown-item:hover { background: rgba(255,255,255,0.12); }
    .domino-dropdown-item.danger { color: #f87171; }

    .domino-opp-tiles {
      display: flex; gap: 2px; justify-content: center; padding: 0.15rem 0.5rem;
      background: linear-gradient(180deg, #152d6e 0%, #1e3a8a 100%);
    }
    .domino-tile-back {
      width: 20px; height: 34px; border-radius: 4px;
      background: linear-gradient(180deg, #5b9cf6 0%, #3b7de8 50%, #2a5fc4 100%);
      border: 1.5px solid #7db8ff; box-shadow: 1px 2px 3px rgba(0,0,0,0.25);
    }

    .domino-timer-bar { height: 5px; background: #1e3a8a; position: relative; }
    .domino-timer-fill {
      height: 100%; border-radius: 0 2px 2px 0;
      transition: width 1s linear;
    }
    .domino-timer-fill.green { background: linear-gradient(90deg, #22c55e, #4ade80); }
    .domino-timer-fill.yellow { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
    .domino-timer-fill.red { background: linear-gradient(90deg, #ef4444, #f87171); }

    .domino-board-area {
      flex: 1; position: relative; overflow: hidden;
      margin: 0.3rem 0.5rem;
      min-height: 0;
      background: rgba(30,90,210,0.25);
      border-radius: 10px;
      border: 2.5px solid rgba(96,165,250,0.35);
      box-shadow: inset 0 2px 12px rgba(0,0,0,0.15);
    }
    .domino-board-inner {
      position: absolute; inset: 0; overflow-x: hidden; overflow-y: auto;
      display: flex; align-items: flex-start; justify-content: center;
      padding: 6px 0;
    }
    .domino-board-canvas { position: relative; }
    .domino-chain-empty {
      color: rgba(255,255,255,0.35); font-style: italic; font-size: 1rem;
      position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
    }
    .domino-boneyard {
      position: absolute; right: 0.5rem; bottom: 0.5rem;
      display: flex; flex-direction: column; align-items: center; gap: 0.2rem;
    }
    .domino-boneyard-stack { position: relative; width: 28px; height: 44px; }
    .domino-boneyard-card {
      position: absolute; width: 24px; height: 40px; border-radius: 4px;
      background: linear-gradient(180deg, #5b9cf6, #2a5fc4); border: 1.5px solid #7db8ff;
    }
    .domino-boneyard-count { font-size: 0.75rem; color: rgba(255,255,255,0.7); font-weight: 600; }

    .dtile {
      display: inline-flex; background: #fff; border-radius: 5px;
      box-shadow: 1px 2px 6px rgba(0,0,0,0.4); position: relative;
    }
    .dtile-h { flex-direction: row; }
    .dtile-v { flex-direction: column; }
    .dtile-half { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; }
    .dtile-div-h { width: 1px; height: 24px; background: #ccc; align-self: center; }
    .dtile-div-v { height: 1px; width: 24px; background: #ccc; align-self: center; }
    .pip-container { width: 22px; height: 22px; display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); }
    .pip { width: 5px; height: 5px; background: #111; border-radius: 50%; align-self: center; justify-self: center; }
    .dtile-board { position: absolute; }
    .dtile-hand-tile {
      display: inline-flex; border-radius: 5px; box-shadow: 1px 2px 5px rgba(0,0,0,0.35);
      background: linear-gradient(180deg, #e8e8e8 0%, #c8c8c8 100%); border: 1.5px solid #aaa;
    }
    .dtile-hand-tile .pip { background: #222; }

    @media (max-width: 480px) {
      .dtile-half { width: 20px; height: 20px; }
      .dtile-div-h { height: 17px; }
      .dtile-div-v { width: 17px; }
      .pip-container { width: 16px; height: 16px; }
      .pip { width: 3.5px; height: 3.5px; }
      .dtile { border-radius: 3px; }
      .dtile-hand-tile { border-radius: 3px; }
      .domino-tile-back { width: 16px; height: 28px; border-radius: 3px; }
      .domino-boneyard-stack { width: 22px; height: 36px; }
      .domino-boneyard-card { width: 18px; height: 32px; border-radius: 3px; }
      .domino-opp-bar { padding: 0.15rem 0.5rem; }
      .domino-avatar { width: 30px; height: 30px; font-size: 0.85rem; }
      .domino-score-big { font-size: 1rem; }
      .domino-username { font-size: 0.7rem; }
      .domino-opp-bar .back-btn, .domino-menu-btn { width: 28px; height: 28px; font-size: 1rem; }
      .domino-my-hand { padding: 0.2rem 0.3rem; gap: 2px; }
      .domino-hand-wrap.selected { transform: translateY(-6px); }
      .domino-hand-wrap:hover { transform: translateY(-4px); }
      .side-btn { padding: 0.3rem 0.7rem; font-size: 0.7rem; }
      .draw-btn { padding: 0.3rem 0.8rem; font-size: 0.75rem; }
      .domino-my-bar { padding: 0.15rem 0.5rem 0.2rem; }
      .domino-my-top-row { gap: 0.3rem; }
    }
    @media (max-width: 380px) {
      .dtile-half { width: 18px; height: 18px; }
      .dtile-div-h { height: 15px; }
      .dtile-div-v { width: 15px; }
      .pip-container { width: 14px; height: 14px; }
      .pip { width: 3px; height: 3px; }
      .domino-tile-back { width: 14px; height: 24px; }
      .domino-boneyard-stack { width: 20px; height: 32px; }
      .domino-boneyard-card { width: 16px; height: 28px; }
    }

    .domino-my-hand {
      display: flex; gap: 3px; justify-content: center; flex-wrap: nowrap;
      padding: 0.3rem 0.5rem;
      background: linear-gradient(180deg, #2563eb 0%, #1e3a8a 100%);
      border-top: 3px solid #3b82f6; overflow-x: auto;
    }
    .domino-hand-wrap {
      cursor: pointer; transition: transform 0.15s, box-shadow 0.15s;
      border: 2px solid transparent; border-radius: 6px; flex-shrink: 0;
    }
    .domino-hand-wrap:hover { transform: translateY(-6px); box-shadow: 0 6px 16px rgba(0,0,0,0.5); }
    .domino-hand-wrap.selected { border-color: #fbbf24; transform: translateY(-10px); box-shadow: 0 0 18px rgba(251,191,36,0.6); }

    .domino-my-bar {
      display: flex; flex-direction: column; align-items: center;
      padding: 0.2rem 1rem 0.3rem;
      background: linear-gradient(180deg, #1e3a8a 0%, #0c1d4d 100%);
    }
    .domino-my-top-row { display: flex; align-items: center; gap: 0.5rem; }
    .domino-turn-pill {
      display: inline-block; padding: 0.15rem 1rem; border-radius: 999px;
      font-size: 0.75rem; font-weight: 700; margin-top: 0.1rem;
    }
    .domino-turn-pill.active { background: #2563eb; color: #fff; }
    .domino-turn-pill.waiting { background: #374151; color: #6b7280; }

    .domino-actions {
      display: flex; gap: 0.5rem; align-items: center; justify-content: center; padding: 0.2rem 0;
    }
    .side-btn {
      background: rgba(255,255,255,0.15); border: 2px solid #60a5fa; color: #93c5fd;
      border-radius: 8px; padding: 0.4rem 0.9rem; font-family: inherit;
      font-weight: 700; font-size: 0.8rem; cursor: pointer; transition: all 0.15s;
    }
    .side-btn:hover { background: #3b82f6; color: #fff; }
    .draw-btn {
      background: #f59e0b; color: #000; border: none; border-radius: 8px;
      padding: 0.5rem 1.2rem; font-family: inherit; font-weight: 700; cursor: pointer; font-size: 0.85rem;
    }
    .draw-btn:hover { background: #d97706; }
    .pass-btn {
      background: #ef4444; color: #fff; border: none; border-radius: 8px;
      padding: 0.5rem 1.2rem; font-family: inherit; font-weight: 700; cursor: pointer; font-size: 0.85rem;
    }
    .pass-btn:hover { background: #dc2626; }

    .ttt-grid { display: grid; gap: 5px; }
    .ttt-cell {
      background: var(--surface); border: 2px solid var(--surface2); border-radius: var(--radius-sm);
      display: flex; align-items: center; justify-content: center;
      font-weight: 800; cursor: pointer; transition: background 0.15s, border-color 0.15s; user-select: none;
    }
    .ttt-cell:hover { border-color: var(--accent); background: var(--bg2); }
    .ttt-cell.x { color: var(--accent2); }
    .ttt-cell.o { color: var(--gold); }
    .ttt-cell.taken { cursor: default; }

    /* ═══ MANCALA ═══ */
    .mancala-screen {
      display: flex; flex-direction: column; position: fixed; inset: 0; z-index: 10;
      background: linear-gradient(180deg, #5b3a1a 0%, #8b6914 30%, #a07d2e 50%, #8b6914 70%, #5b3a1a 100%);
      font-family: 'Inter', sans-serif; color: #fff; overflow: hidden;
    }
    .mancala-topbar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0.5rem 1rem; background: rgba(0,0,0,0.3);
    }
    .mancala-topbar .back-btn {
      width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.12);
      border: none; color: #fff; font-size: 1.2rem; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    .mancala-player-info { text-align: center; }
    .mancala-player-info .name { font-weight: 700; font-size: 0.9rem; }
    .mancala-player-info .score { font-size: 1.5rem; font-weight: 800; color: #fbbf24; }
    .mancala-timer { height: 4px; background: rgba(0,0,0,0.3); }
    .mancala-timer-fill { height: 100%; border-radius: 0 2px 2px 0; transition: width 1s linear; }
    .mancala-board-wrap {
      flex: 1; display: flex; align-items: center; justify-content: center; padding: 0.5rem;
    }
    .mancala-board {
      display: grid; grid-template-columns: auto repeat(6, 1fr) auto;
      grid-template-rows: 1fr 1fr; gap: 6px;
      background: linear-gradient(135deg, #654321, #8B7355);
      border: 4px solid #4a3520; border-radius: 60px; padding: 12px 8px;
      box-shadow: inset 0 4px 20px rgba(0,0,0,0.5), 0 8px 32px rgba(0,0,0,0.4);
      width: 100%; max-width: 540px;
    }
    .mancala-store {
      grid-row: 1 / 3; display: flex; flex-direction: column; align-items: center; justify-content: center;
      background: radial-gradient(ellipse, #3a2a10 0%, #2a1a08 100%);
      border-radius: 40px; min-width: 48px; min-height: 100px; padding: 8px;
      box-shadow: inset 0 3px 10px rgba(0,0,0,0.6); position: relative;
    }
    .mancala-store-count {
      font-size: 1.6rem; font-weight: 800; color: #fbbf24;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    .mancala-store-label { font-size: 0.6rem; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1px; }
    .mancala-pit {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      background: radial-gradient(circle, #3a2a10 0%, #2a1a08 100%);
      border-radius: 50%; aspect-ratio: 1; min-width: 38px;
      box-shadow: inset 0 3px 8px rgba(0,0,0,0.6); cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s; position: relative;
    }
    .mancala-pit:hover { transform: scale(1.08); box-shadow: inset 0 3px 8px rgba(0,0,0,0.6), 0 0 12px rgba(251,191,36,0.4); }
    .mancala-pit.disabled { cursor: default; opacity: 0.6; }
    .mancala-pit.disabled:hover { transform: none; box-shadow: inset 0 3px 8px rgba(0,0,0,0.6); }
    .mancala-seeds {
      display: flex; flex-wrap: wrap; gap: 2px; justify-content: center; align-items: center;
      max-width: 36px; padding: 2px;
    }
    .mancala-seed {
      width: 8px; height: 8px; border-radius: 50%;
      box-shadow: 0 1px 2px rgba(0,0,0,0.4);
    }
    .mancala-seed.s-me {
      background: radial-gradient(circle at 30% 30%, #60d4f0, #1a8fb5);
    }
    .mancala-seed.s-opp {
      background: radial-gradient(circle at 30% 30%, #f07060, #c0392b);
    }
    .mancala-seed.s-mix {
      background: radial-gradient(circle at 30% 30%, #c9a96e, #8b6914);
    }
    .mancala-pit-count {
      font-size: 0.7rem; font-weight: 700; color: rgba(255,255,255,0.7); margin-top: 2px;
    }
    .mancala-turn-pill {
      display: inline-block; padding: 0.3rem 1.2rem; border-radius: 999px;
      font-size: 0.85rem; font-weight: 700; margin-top: 0.3rem;
    }
    .mancala-turn-pill.active { background: #d97706; color: #fff; }
    .mancala-turn-pill.waiting { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.5); }
    .mancala-menu-wrap { position: relative; }
    .mancala-menu-btn {
      width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.12);
      border: none; color: #fff; font-size: 1.2rem; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    .mancala-flying-seed {
      position: fixed; width: 12px; height: 12px; border-radius: 50%;
      box-shadow: 0 2px 6px rgba(0,0,0,0.5); z-index: 200;
      pointer-events: none; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .mancala-flying-seed.s-me { background: radial-gradient(circle at 30% 30%, #60d4f0, #1a8fb5); }
    .mancala-flying-seed.s-opp { background: radial-gradient(circle at 30% 30%, #f07060, #c0392b); }
    @media (max-width: 480px) {
      .mancala-board { border-radius: 40px; padding: 8px 4px; gap: 4px; }
      .mancala-store { min-width: 36px; min-height: 80px; border-radius: 30px; }
      .mancala-store-count { font-size: 1.2rem; }
      .mancala-pit { min-width: 32px; }
      .mancala-seed { width: 6px; height: 6px; }
      .mancala-seeds { max-width: 28px; }
      .mancala-flying-seed { width: 9px; height: 9px; }
    }

    /* ═══ CHECKERS ═══ */
    .checkers-screen {
      display: flex; flex-direction: column; position: fixed; inset: 0; z-index: 10;
      background: linear-gradient(180deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      font-family: 'Inter', sans-serif; color: #fff; overflow: hidden;
    }
    .checkers-topbar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0.5rem 1rem; background: rgba(0,0,0,0.3);
    }
    .checkers-topbar .back-btn {
      width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.12);
      border: none; color: #fff; font-size: 1.2rem; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    .checkers-player-info { text-align: center; }
    .checkers-player-info .name { font-weight: 700; font-size: 0.9rem; }
    .checkers-player-info .pieces-count { font-size: 0.8rem; color: #93c5fd; }
    .checkers-timer { height: 4px; background: rgba(0,0,0,0.3); }
    .checkers-timer-fill { height: 100%; border-radius: 0 2px 2px 0; transition: width 1s linear; }
    .checkers-board-wrap {
      flex: 1; display: flex; align-items: center; justify-content: center; padding: 0.5rem;
    }
    .checkers-board {
      display: grid; grid-template-columns: repeat(8, 1fr); gap: 0;
      width: min(90vw, 90vh - 160px, 480px); aspect-ratio: 1;
      border: 3px solid #8b6914; border-radius: 4px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    }
    .checkers-sq {
      aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
      position: relative; cursor: default;
    }
    .checkers-sq[data-checkers-select], .checkers-sq[data-checkers-move] { cursor: pointer; }
    .checkers-sq.light { background: #f0d9b5; }
    .checkers-sq.dark { background: #b58863; }
    .checkers-sq.highlight {
      background: #7fb069; cursor: pointer;
      box-shadow: inset 0 0 12px rgba(0,255,0,0.3);
    }
    .checkers-sq.highlight::after {
      content: ''; position: absolute; width: 40%; height: 40%; border-radius: 50%;
      background: rgba(255,255,255,0.4); pointer-events: none;
    }
    .checkers-sq.selected {
      background: #e8c840;
      box-shadow: inset 0 0 12px rgba(255,200,0,0.4);
    }
    .checkers-piece {
      width: 80%; height: 80%; border-radius: 50%; position: relative;
      box-shadow: 0 3px 6px rgba(0,0,0,0.4); transition: transform 0.15s;
      pointer-events: none;
    }
    .checkers-piece.p0 {
      background: radial-gradient(circle at 35% 35%, #ff6b6b, #c0392b);
      border: 2px solid #922b21;
    }
    .checkers-piece.p1 {
      background: radial-gradient(circle at 35% 35%, #555, #222);
      border: 2px solid #111;
    }
    .checkers-piece.king::after {
      content: '♛'; position: absolute; inset: 0;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.2em; color: #fbbf24; text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }
    .checkers-piece.selectable { cursor: pointer; }
    .checkers-piece.selectable:hover { transform: scale(1.1); }
    .checkers-turn-pill {
      display: inline-block; padding: 0.3rem 1.2rem; border-radius: 999px;
      font-size: 0.85rem; font-weight: 700; margin-top: 0.3rem;
    }
    .checkers-turn-pill.active { background: #e74c3c; color: #fff; }
    .checkers-turn-pill.waiting { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.5); }
    .checkers-menu-wrap { position: relative; }
    .checkers-menu-btn {
      width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.12);
      border: none; color: #fff; font-size: 1.2rem; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    @media (max-width: 480px) {
      .checkers-piece.king::after { font-size: 0.9em; }
    }

    /* ═══ CHESS ═══ */
    .chess-screen {
      display: flex; flex-direction: column; position: fixed; inset: 0; z-index: 10;
      background: linear-gradient(180deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
      font-family: 'Inter', sans-serif; color: #fff; overflow: hidden;
    }
    .chess-topbar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0.5rem 1rem; background: rgba(0,0,0,0.4);
    }
    .chess-topbar .back-btn {
      width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.12);
      border: none; color: #fff; font-size: 1.2rem; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    .chess-player-info { text-align: center; }
    .chess-player-info .name { font-weight: 700; font-size: 0.9rem; }
    .chess-player-info .material { font-size: 0.8rem; color: #93c5fd; }
    .chess-timer { height: 4px; background: rgba(0,0,0,0.3); }
    .chess-timer-fill { height: 100%; border-radius: 0 2px 2px 0; transition: width 1s linear; }
    .chess-board-wrap {
      flex: 1; display: flex; align-items: center; justify-content: center; padding: 0.5rem;
    }
    .chess-board {
      display: grid; grid-template-columns: repeat(8, 1fr); gap: 0;
      width: min(90vw, 90vh - 160px, 480px); aspect-ratio: 1;
      border: 3px solid #8b6914; border-radius: 4px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    }
    .chess-sq {
      aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
      position: relative; cursor: default; font-size: min(8vw, 3.5rem);
    }
    .chess-sq[data-chess-select], .chess-sq[data-chess-move] { cursor: pointer; }
    .chess-sq.light { background: #f0d9b5; }
    .chess-sq.dark { background: #b58863; }
    .chess-sq.highlight { cursor: pointer; position: relative; }
    .chess-sq.highlight::after {
      content: ''; position: absolute; width: 30%; height: 30%; border-radius: 50%;
      background: rgba(0,0,0,0.25);
    }
    .chess-sq.highlight.has-piece::after {
      width: 90%; height: 90%; background: none; border: 3px solid rgba(0,0,0,0.25); border-radius: 50%;
    }
    .chess-sq.selected { background: #e8c840; }
    .chess-sq.last-move { background: rgba(255,255,100,0.3); }
    .chess-sq.in-check { background: radial-gradient(circle, #ff0000 0%, transparent 70%); }
    .chess-piece {
      user-select: none; cursor: pointer; pointer-events: none;
      transition: transform 0.1s; line-height: 1;
      -webkit-text-stroke: 0.5px rgba(0,0,0,0.3);
    }
    .chess-piece.white-piece {
      color: #fff; text-shadow: 0 1px 3px rgba(0,0,0,0.5), 0 0 1px rgba(0,0,0,0.8);
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.4));
    }
    .chess-piece.black-piece {
      color: #1a1a1a; text-shadow: 0 1px 2px rgba(0,0,0,0.3);
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
    }
    .chess-piece:hover { transform: scale(1.15); }
    .chess-turn-pill {
      display: inline-block; padding: 0.3rem 1.2rem; border-radius: 999px;
      font-size: 0.85rem; font-weight: 700; margin-top: 0.3rem;
    }
    .chess-turn-pill.active { background: var(--accent); color: #fff; }
    .chess-turn-pill.waiting { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.5); }
    .chess-menu-wrap { position: relative; }
    .chess-menu-btn {
      width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.12);
      border: none; color: #fff; font-size: 1.2rem; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    .chess-promo-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex;
      align-items: center; justify-content: center; z-index: 100;
    }
    .chess-promo-box {
      background: #2d2d2d; border: 2px solid #8b6914; border-radius: 12px; padding: 1.5rem;
      display: flex; gap: 0.5rem;
    }
    .chess-promo-btn {
      width: 60px; height: 60px; font-size: 2.5rem; background: #f0d9b5; border: 2px solid #8b6914;
      border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: transform 0.15s, background 0.15s;
    }
    .chess-promo-btn:hover { transform: scale(1.1); background: #e8c840; }

    /* ═══ MORPION (Five in a Row) ═══ */
    .morpion-screen {
      display: flex; flex-direction: column; position: fixed; inset: 0; z-index: 10;
      background: linear-gradient(180deg, #0a192f 0%, #112240 40%, #1a365d 100%);
      font-family: 'Inter', sans-serif; color: #fff; overflow: hidden;
    }
    .morpion-topbar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0.5rem 1rem; background: rgba(0,0,0,0.3);
    }
    .morpion-topbar .back-btn {
      width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.12);
      border: none; color: #fff; font-size: 1.2rem; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    .morpion-player-info { text-align: center; }
    .morpion-player-info .name { font-weight: 700; font-size: 0.9rem; }
    .morpion-player-info .symbol { font-size: 1.2rem; font-weight: 800; }
    .morpion-player-info .symbol.x-color { color: #ef4444; }
    .morpion-player-info .symbol.o-color { color: #3b82f6; }
    .morpion-timer { height: 4px; background: rgba(0,0,0,0.3); }
    .morpion-timer-fill { height: 100%; border-radius: 0 2px 2px 0; transition: width 1s linear; }
    .morpion-board-wrap {
      flex: 1; display: flex; align-items: center; justify-content: center;
      padding: 0.5rem; overflow: hidden;
    }
    .morpion-board {
      display: grid; gap: 0;
      width: min(95vw, 80vh - 120px, 520px); aspect-ratio: 1;
      background: #e8dcc8;
      border: 2px solid #8b6914; border-radius: 4px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    }
    .morpion-cell {
      aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
      border: 0.5px solid rgba(0,0,0,0.2); cursor: pointer;
      transition: background 0.12s; position: relative;
      font-weight: 800; user-select: none;
    }
    .morpion-cell:hover { background: rgba(0,0,0,0.08); }
    .morpion-cell.taken { cursor: default; }
    .morpion-cell.taken:hover { background: transparent; }
    .morpion-cell.last-move { background: rgba(251,191,36,0.25); }
    .morpion-cell.win-cell { background: rgba(34,197,94,0.35); }
    .morpion-cell .x-mark {
      color: #dc2626; font-size: min(3vw, 1.4rem); line-height: 1;
    }
    .morpion-cell .o-mark {
      color: #2563eb; font-size: min(3vw, 1.4rem); line-height: 1;
    }
    .morpion-turn-pill {
      display: inline-block; padding: 0.3rem 1.2rem; border-radius: 999px;
      font-size: 0.85rem; font-weight: 700; margin-top: 0.3rem;
    }
    .morpion-turn-pill.active { background: var(--accent); color: #fff; }
    .morpion-turn-pill.waiting { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.5); }
    .morpion-menu-wrap { position: relative; }
    .morpion-menu-btn {
      width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.12);
      border: none; color: #fff; font-size: 1.2rem; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    @media (max-width: 480px) {
      .morpion-cell .x-mark, .morpion-cell .o-mark { font-size: min(4.5vw, 1.1rem); }
    }

    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .overlay.hidden { display: none; }
    .overlay-box {
      background: linear-gradient(135deg, var(--bg2), var(--surface));
      border: 1px solid var(--surface2); border-radius: var(--radius); padding: 2.5rem;
      text-align: center; max-width: 420px; width: 90%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }
    .overlay-box h2 { font-size: 1.8rem; margin-bottom: 0.5rem; }
    .overlay-box p { color: var(--text2); margin-bottom: 0.5rem; }
    .payout-text { font-size: 1.4rem; font-weight: 800; color: var(--gold); margin: 1rem 0; text-shadow: 0 0 20px rgba(255,193,7,0.2); }

    .wallet-panel {
      background: linear-gradient(135deg, var(--bg2), var(--surface));
      border: 1px solid var(--surface2); border-radius: var(--radius);
      padding: 1.2rem 1.4rem; margin-bottom: 2rem;
      display: grid; grid-template-columns: 1fr auto; gap: 0.5rem 2rem; align-items: start;
    }
    .wallet-panel h3 {
      font-size: 0.85rem; margin-bottom: 0.6rem; display: flex; align-items: center; gap: 0.5rem;
      text-transform: uppercase; letter-spacing: 1px; color: var(--text2); grid-column: 1 / -1;
    }
    .balance-display {
      font-size: 2.2rem; font-weight: 800; color: var(--gold); margin-bottom: 0.1rem;
      text-shadow: 0 0 30px rgba(255,193,7,0.15);
    }
    .balance-sub { font-size: 0.75rem; color: var(--text2); margin-bottom: 0.5rem; }
    .wallet-address-box {
      background: var(--bg); border: 1px solid var(--surface2); border-radius: 6px;
      padding: 0.5rem 0.7rem; font-family: monospace; font-size: 0.7rem; color: var(--accent);
      word-break: break-all; margin-bottom: 0.5rem; cursor: pointer; transition: border-color 0.2s;
    }
    .wallet-address-box:hover { border-color: var(--accent); }
    .wallet-address-label { font-size: 0.7rem; color: var(--text2); margin-bottom: 0.2rem; display: block; }
    .wallet-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .wallet-actions input[type="number"] {
      background: var(--bg); border: 2px solid var(--surface2); border-radius: 6px;
      padding: 0.5rem 0.7rem; color: var(--text); font-family: inherit; font-size: 0.9rem;
      outline: none; width: 140px; transition: border-color 0.2s;
    }
    .wallet-actions input[type="number"]:focus { border-color: var(--accent); }
    .btn-deposit { background: var(--green); color: #fff; border: none; border-radius: 6px; padding: 0.5rem 1rem; font-weight: 700; cursor: pointer; font-family: inherit; }
    .btn-deposit:hover { opacity: 0.85; }
    .btn-withdraw { background: var(--red); color: #fff; border: none; border-radius: 6px; padding: 0.5rem 1rem; font-weight: 700; cursor: pointer; font-family: inherit; }
    .btn-withdraw:hover { opacity: 0.85; }
    .wallet-row { display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.6rem; flex-wrap: wrap; }
    .wallet-row label { font-size: 0.85rem; color: var(--text2); min-width: 70px; }
    .status-msg { margin-top: 0.6rem; padding: 0.5rem 0.8rem; border-radius: 8px; font-size: 0.85rem; font-weight: 600; display: none; }

    @media (max-width: 700px) {
      .game-cards { grid-template-columns: 1fr; }
      .pending-bet-card { flex-wrap: wrap; gap: 0.6rem; }
      .pending-bet-amount { text-align: left; }
      .pending-bet-accept { width: 100%; text-align: center; }
      .topbar { flex-wrap: wrap; gap: 0.5rem; }
      .logo h1 { font-size: 2rem; }
      .logo-mark { width: 64px; height: 64px; font-size: 1.8rem; }
      .connect-stats { gap: 0.6rem; }
      .stat-pill { padding: 0.5rem 0.8rem; min-width: 65px; }
      .stat-value { font-size: 1rem; }
      .wallet-panel { grid-template-columns: 1fr; }
      .pending-bets-section { padding: 1rem; }
    }
  </style>
</head>
<body>

  <!-- CONNECT SCREEN -->
  <div id="screen-connect" class="screen active">
    <video class="video-bg" autoplay muted loop playsinline>
      <source src="/bg_1.mp4" type="video/mp4" />
    </video>
    <div class="connect-container">
      <div class="logo">
        <div class="logo-mark"><img src="/zootcoin.png" alt="ZG" style="width:100%;height:100%;object-fit:cover;border-radius:inherit;" /></div>
        <h1><span class="accent">Zoot</span> Games</h1>
        <div class="logo-subtitle">Bet &bull; Play &bull; Win Crypto</div>
      </div>
      <p class="tagline">Wager SOL on classic games. Beat real opponents. Win instantly.</p>

      <div class="connect-stats">
        <div class="stat-pill"><span class="stat-value" id="connect-online">--</span><span class="stat-label">Online Now</span></div>
        <div class="stat-pill"><span class="stat-value">1.8x</span><span class="stat-label">Payout</span></div>
      </div>

      <div class="connect-form">
        <button id="btn-connect-phantom" class="btn-phantom">
          <img src="https://phantom.app/img/phantom-icon-purple.png" alt="" onerror="this.style.display='none'" />
          Connect &amp; Start Betting
        </button>
        <p class="small-text">Secured by Solana blockchain &mdash; instant payouts</p>
        <p id="connect-error" style="color:var(--red);font-size:0.85rem;display:none;"></p>
      </div>
    </div>
  </div>

  <!-- LOBBY SCREEN -->
  <div id="screen-lobby" class="screen">
    <header class="topbar">
      <div class="topbar-left">
        <span class="logo-sm"><span class="logo-sm-mark"><img src="/zootcoin.png" alt="ZG" style="width:100%;height:100%;object-fit:cover;border-radius:inherit;" /></span><span><span class="accent">Zoot</span> Games</span></span>
      </div>
      <div class="topbar-center"><span id="online-count" class="badge badge-live">0 online</span></div>
      <div class="topbar-right">
        <span id="topbar-balance" class="badge" style="color:var(--gold);font-weight:700;border-color:rgba(255,193,7,0.2);">0 SOL</span>
        <span id="wallet-display" class="wallet-badge"></span>
      </div>
    </header>
    <main class="lobby-main">
      <div class="wallet-panel">
        <h3>&#128176; Your Wallet</h3>
        <div class="balance-display"><span id="balance-amount">--</span> SOL</div>
        <div class="balance-sub">Your real Solana wallet balance &mdash; this SOL is used for bets</div>
        <div style="display:flex;align-items:center;gap:0.6rem;margin-bottom:0.8rem;">
          <span style="font-size:0.8rem;color:var(--text2);">Network:</span>
          <select id="network-select" style="background:var(--surface);border:1px solid var(--surface2);color:var(--accent2);border-radius:6px;padding:0.3rem 0.6rem;font-size:0.8rem;font-family:inherit;cursor:pointer;">
            <option value="mainnet-beta">Mainnet</option>
            <option value="devnet">Devnet</option>
            <option value="testnet">Testnet</option>
          </select>
          <span id="network-indicator" style="font-size:0.7rem;padding:0.2rem 0.5rem;border-radius:999px;background:var(--green);color:#fff;font-weight:600;">Mainnet</span>
        </div>
        <span class="wallet-address-label">Connected wallet (click to copy):</span>
        <div class="wallet-address-box" id="connected-wallet-addr" title="Click to copy">Loading...</div>
        <button id="btn-refresh-balance" class="btn" style="padding:0.4rem 1rem;font-size:0.85rem;background:var(--surface2);color:var(--text);margin-top:0.3rem;">&#x21bb; Refresh Balance</button>
      </div>

      <div class="zootcoin-banner">
        <div class="zootcoin-banner-icon"><img src="/zootcoin.png" alt="ZootCoin" style="width:40px;height:40px;border-radius:50%;object-fit:cover;" /></div>
        <div class="zootcoin-banner-text">
          <h3>ZootCoin <span class="soon-tag">COMING SOON</span></h3>
          <p>Our native token for playing against the house. Wager ZootCoin on Blackjack and more &mdash; all games will support ZootCoin for house mode. Player vs Player stays on SOL + ZootCoin.</p>
        </div>
      </div>

      <h2>Choose Your Game</h2>
      <div class="game-cards">
        <div class="game-card" data-game="domino">
          <div class="game-card-header">
            <div class="game-card-icon">&#127073;</div>
            <h3>Domino</h3>
          </div>
          <span class="multiplier-badge">1.8x Payout</span>
          <p>Classic 1v1 &mdash; 7 tiles each, draw from the pile, block your opponent</p>
          <div class="bet-input-group">
            <label>Bet:</label>
            <input type="number" class="bet-amount-input" placeholder="0.5" min="0.001" step="0.001" value="0.5" />
            <span class="sol-label">SOL</span>
          </div>
          <button class="btn btn-primary btn-play">Find Match</button>
        </div>

        <div class="game-card" data-game="tictactoe">
          <div class="game-card-header">
            <div class="game-card-icon">&#10005;&#9675;</div>
            <h3>Tic Tac Toe</h3>
          </div>
          <span class="multiplier-badge">1.8x Payout</span>
          <p>Outsmart your opponent &mdash; pick your grid size and go!</p>
          <div class="grid-select">
            <label>Grid Size:</label>
            <div class="grid-options">
              <button class="grid-btn active" data-grid="3">3&times;3</button>
              <button class="grid-btn" data-grid="5">5&times;5</button>
              <button class="grid-btn" data-grid="7">7&times;7</button>
            </div>
          </div>
          <div class="bet-input-group">
            <label>Bet:</label>
            <input type="number" class="bet-amount-input" placeholder="0.5" min="0.001" step="0.001" value="0.5" />
            <span class="sol-label">SOL</span>
          </div>
          <button class="btn btn-primary btn-play">Find Match</button>
        </div>

        <div class="game-card" data-game="mancala">
          <div class="game-card-header">
            <div class="game-card-icon">&#127794;</div>
            <h3>Mancala</h3>
          </div>
          <span class="multiplier-badge">1.8x Payout</span>
          <p>Ancient strategy &mdash; sow seeds, capture stones, fill your store!</p>
          <div class="bet-input-group">
            <label>Bet:</label>
            <input type="number" class="bet-amount-input" placeholder="0.5" min="0.001" step="0.001" value="0.5" />
            <span class="sol-label">SOL</span>
          </div>
          <button class="btn btn-primary btn-play">Find Match</button>
        </div>

        <div class="game-card" data-game="checkers">
          <div class="game-card-header">
            <div class="game-card-icon">&#9823;</div>
            <h3>Checkers</h3>
          </div>
          <span class="multiplier-badge">1.8x Payout</span>
          <p>Jump, capture &amp; king your pieces &mdash; classic 8&times;8 board battle!</p>
          <div class="bet-input-group">
            <label>Bet:</label>
            <input type="number" class="bet-amount-input" placeholder="0.5" min="0.001" step="0.001" value="0.5" />
            <span class="sol-label">SOL</span>
          </div>
          <button class="btn btn-primary btn-play">Find Match</button>
        </div>

        <div class="game-card" data-game="chess">
          <div class="game-card-header">
            <div class="game-card-icon">&#9812;</div>
            <h3>Chess</h3>
          </div>
          <span class="multiplier-badge">1.8x Payout</span>
          <p>The ultimate strategy game &mdash; checkmate your opponent to win!</p>
          <div class="bet-input-group">
            <label>Bet:</label>
            <input type="number" class="bet-amount-input" placeholder="0.5" min="0.001" step="0.001" value="0.5" />
            <span class="sol-label">SOL</span>
          </div>
          <button class="btn btn-primary btn-play">Find Match</button>
        </div>

        <div class="game-card" data-game="morpion">
          <div class="game-card-icon">&#10010;</div>
          <h3>Morpion</h3>
          <p>Connect 5 in a row on a 15&times;15 grid &mdash; think ahead to win!</p>
          <div class="bet-input-group">
            <label>Bet:</label>
            <input type="number" class="bet-amount-input" placeholder="0.5" min="0.001" step="0.001" value="0.5" />
            <span class="sol-label">SOL</span>
          </div>
          <button class="btn btn-primary btn-play">Find Match</button>
        </div>

        <div class="game-card coming-soon" data-game="blackjack">
          <div class="game-card-header">
            <div class="game-card-icon">&#127183;</div>
            <h3>Blackjack</h3>
          </div>
          <span class="badge-house">vs House</span>
          <span class="badge-zootcoin"><img src="/zootcoin.png" alt="" style="width:14px;height:14px;border-radius:50%;object-fit:cover;" /> ZootCoin Only</span>
          <p>Beat the dealer to 21 &mdash; play against the house and win ZootCoin!</p>
          <button class="btn btn-primary btn-play" disabled style="opacity:0.4;">Coming Soon</button>
        </div>
      </div>

      <section class="pending-bets-section">
        <h2>&#128293; Open Challenges <span class="pending-count" id="pending-count">0</span></h2>
        <div class="pending-filter" id="pending-filter">
          <button class="pending-filter-btn active" data-filter="all">All</button>
          <button class="pending-filter-btn" data-filter="domino">&#127073; Domino</button>
          <button class="pending-filter-btn" data-filter="tictactoe">&#10005;&#9675; Tic Tac Toe</button>
          <button class="pending-filter-btn" data-filter="mancala">&#127794; Mancala</button>
          <button class="pending-filter-btn" data-filter="checkers">&#9823; Checkers</button>
          <button class="pending-filter-btn" data-filter="chess">&#9812; Chess</button>
          <button class="pending-filter-btn" data-filter="morpion">&#10010; Morpion</button>
        </div>
        <div class="pending-bets-list" id="pending-bets-list">
          <div class="pending-empty">No open challenges yet &mdash; create one above!</div>
        </div>
      </section>

      <section class="live-section">
        <div class="live-col">
          <h4>&#9876;&#65039; Active Games</h4>
          <ul id="active-list" class="activity-list"></ul>
        </div>
      </section>
    </main>
  </div>

  <!-- WAITING SCREEN -->
  <div id="screen-waiting" class="screen">
    <div class="waiting-container">
      <div class="spinner"></div>
      <h2>Searching for opponent...</h2>
      <p id="waiting-info"></p>
      <button id="btn-cancel-search" class="btn btn-danger">Cancel</button>
    </div>
  </div>

  <!-- GAME SCREEN -->
  <div id="screen-game" class="screen">
    <header class="game-topbar">
      <div class="game-info">
        <span id="game-type-label" class="badge badge-game"></span>
        <span id="game-bet-label" class="badge badge-bet"></span>
      </div>
      <div class="game-players">
        <span id="player1-label" class="player-label"></span>
        <span class="vs">VS</span>
        <span id="player2-label" class="player-label"></span>
      </div>
      <div id="turn-indicator" class="turn-indicator"></div>
    </header>
    <div id="game-area" class="game-area"></div>
    <div id="game-controls" class="game-controls"></div>
  </div>

  <!-- GAME OVER OVERLAY -->
  <div id="overlay-gameover" class="overlay hidden">
    <div class="overlay-box">
      <h2 id="gameover-title"></h2>
      <p id="gameover-detail"></p>
      <p id="gameover-payout" class="payout-text"></p>
      <button id="btn-back-lobby" class="btn btn-primary">Back to Lobby</button>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
  <script>
    // ════════════════════════════════════════
    // GAME SOUNDS (Web Audio API)
    // ════════════════════════════════════════
    var GameSounds = (function() {
      var ctx = null;
      function getCtx() {
        if (!ctx) { try { ctx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {} }
        return ctx;
      }
      function tone(freq, dur, type, vol) {
        var c = getCtx(); if (!c) return;
        var o = c.createOscillator(), g = c.createGain();
        o.type = type || 'sine'; o.frequency.value = freq;
        g.gain.setValueAtTime(vol || 0.15, c.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, c.currentTime + dur);
        o.connect(g); g.connect(c.destination);
        o.start(c.currentTime); o.stop(c.currentTime + dur);
      }
      function noise(dur, vol) {
        var c = getCtx(); if (!c) return;
        var buf = c.createBuffer(1, c.sampleRate * dur, c.sampleRate);
        var data = buf.getChannelData(0);
        for (var i = 0; i < data.length; i++) data[i] = (Math.random() * 2 - 1) * 0.3;
        var src = c.createBufferSource(); src.buffer = buf;
        var g = c.createGain(); g.gain.setValueAtTime(vol || 0.08, c.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, c.currentTime + dur);
        var filt = c.createBiquadFilter(); filt.type = 'bandpass'; filt.frequency.value = 800; filt.Q.value = 1;
        src.connect(filt); filt.connect(g); g.connect(c.destination);
        src.start(c.currentTime); src.stop(c.currentTime + dur);
      }
      return {
        place: function() { tone(600, 0.1, 'sine', 0.12); },
        capture: function() { tone(800, 0.08, 'square', 0.08); setTimeout(function(){ tone(1000, 0.1, 'square', 0.08); }, 80); },
        seedDrop: function() { tone(400 + Math.random() * 200, 0.08, 'triangle', 0.1); noise(0.05, 0.06); },
        seedStore: function() { tone(700, 0.12, 'sine', 0.15); tone(900, 0.12, 'sine', 0.1); },
        move: function() { noise(0.06, 0.07); tone(500, 0.08, 'sine', 0.1); },
        jump: function() { tone(500, 0.06, 'square', 0.1); setTimeout(function(){ tone(650, 0.08, 'square', 0.1); }, 60); },
        king: function() { tone(600, 0.15, 'sine', 0.15); setTimeout(function(){ tone(800, 0.15, 'sine', 0.15); }, 100); setTimeout(function(){ tone(1000, 0.2, 'sine', 0.15); }, 200); },
        check: function() { tone(900, 0.15, 'sawtooth', 0.08); setTimeout(function(){ tone(700, 0.15, 'sawtooth', 0.08); }, 120); },
        win: function() { [523,659,784,1047].forEach(function(f,i){ setTimeout(function(){ tone(f, 0.2, 'sine', 0.15); }, i*120); }); },
        lose: function() { [400,350,300,250].forEach(function(f,i){ setTimeout(function(){ tone(f, 0.25, 'sawtooth', 0.06); }, i*150); }); },
        turn: function() { tone(880, 0.06, 'sine', 0.08); },
        click: function() { tone(1200, 0.04, 'sine', 0.06); },
        resign: function() { tone(300, 0.3, 'sawtooth', 0.06); tone(200, 0.4, 'sawtooth', 0.04); },
        timer: function() { tone(1000, 0.05, 'square', 0.1); },
      };
    })();

    // ════════════════════════════════════════
    // PIP RENDERER
    // ════════════════════════════════════════
    var PipLayouts = {
      0: [], 1: [[1,1]], 2: [[0,2],[2,0]], 3: [[0,2],[1,1],[2,0]],
      4: [[0,0],[0,2],[2,0],[2,2]], 5: [[0,0],[0,2],[1,1],[2,0],[2,2]],
      6: [[0,0],[0,2],[1,0],[1,2],[2,0],[2,2]],
    };

    function renderPips(n) {
      var html = '<div class="pip-container">';
      var cells = [[false,false,false],[false,false,false],[false,false,false]];
      var layout = PipLayouts[n] || [];
      for (var i = 0; i < layout.length; i++) cells[layout[i][0]][layout[i][1]] = true;
      for (var r = 0; r < 3; r++) for (var c = 0; c < 3; c++) html += cells[r][c] ? '<div class="pip"></div>' : '<div></div>';
      return html + '</div>';
    }

    function renderDominoTile(a, b, orient, extraClass) {
      orient = orient || 'h'; extraClass = extraClass || '';
      var isH = orient === 'h';
      var cls = 'dtile ' + (isH ? 'dtile-h' : 'dtile-v') + ' ' + extraClass;
      var div = isH ? '<div class="dtile-div-h"></div>' : '<div class="dtile-div-v"></div>';
      return '<div class="' + cls + '"><div class="dtile-half">' + renderPips(a) + '</div>' + div + '<div class="dtile-half">' + renderPips(b) + '</div></div>';
    }

    function renderHandTile(a, b) {
      return '<div class="dtile-hand-tile dtile-v"><div class="dtile-half">' + renderPips(a) + '</div><div class="dtile-div-v"></div><div class="dtile-half">' + renderPips(b) + '</div></div>';
    }

    // ════════════════════════════════════════
    // PHANTOM WALLET
    // ════════════════════════════════════════
    var PhantomWallet = (function() {
      var provider = null;
      var publicKey = null;
      var network = 'mainnet-beta';

      function getProvider() {
        if (window.solana && window.solana.isPhantom) return window.solana;
        if (window.phantom && window.phantom.solana && window.phantom.solana.isPhantom) return window.phantom.solana;
        return null;
      }

      async function connect() {
        provider = getProvider();
        if (!provider) throw new Error('Phantom wallet not found. Please install it from phantom.app');
        var resp = await provider.connect({ onlyIfTrusted: false });
        publicKey = resp.publicKey.toString();
        return publicKey;
      }

      function disconnect() {
        if (provider) try { provider.disconnect(); } catch(_){}
        publicKey = null;
        provider = null;
      }

      function getPublicKey() { return publicKey; }
      function getProviderRef() { return provider; }
      function getNetwork() { return network; }
      function setNetwork(n) { network = n; }

      function getRpcUrl() {
        if (network === 'devnet') return 'https://api.devnet.solana.com';
        if (network === 'testnet') return 'https://api.testnet.solana.com';
        return 'https://solana-rpc.publicnode.com';
      }

      function shortenAddress(addr) {
        if (!addr) return '';
        return addr.length <= 12 ? addr : addr.slice(0, 6) + '...' + addr.slice(-4);
      }

      return { connect: connect, disconnect: disconnect, getPublicKey: getPublicKey, getProvider: getProviderRef, shortenAddress: shortenAddress, getRpcUrl: getRpcUrl, getNetwork: getNetwork, setNetwork: setNetwork };
    })();

    // ════════════════════════════════════════
    // DOMINO UI — Plato exact replica
    // ════════════════════════════════════════
    var DominoUI = (function() {
      var selectedTileIndex = null;
      var sendActionFn = null;
      var lastState = null;
      var TW = 28, GAP = 0;
      var timerInterval = null;
      var menuOpen = false;

      function startTimer(state) {
        stopTimer();
        if (state.roundOver || state.gameOver) return;
        var remaining = state.turnRemainingMs || 15000;
        var total = state.turnTimeMs || 15000;
        var barEl = document.querySelector('.domino-timer-fill');
        if (!barEl) return;

        var start = Date.now();
        function tick() {
          var elapsed = Date.now() - start;
          var left = Math.max(0, remaining - elapsed);
          var pct = (left / total) * 100;
          barEl.style.width = pct + '%';
          barEl.className = 'domino-timer-fill ' + (pct > 50 ? 'green' : pct > 25 ? 'yellow' : 'red');
          if (left > 0) timerInterval = requestAnimationFrame(tick);
        }
        tick();
      }
      function stopTimer() { if (timerInterval) { cancelAnimationFrame(timerInterval); timerInterval = null; } }

      function render(state, sendAction, gameData) {
        lastState = state; sendActionFn = sendAction;
        var area = document.getElementById('game-area');
        var controls = document.getElementById('game-controls');
        var board = state.board, hand = state.hand;
        var oppCount = state.opponentTileCount, boneCount = state.boneyardCount;
        var isMyTurn = state.isMyTurn;
        var oppName = (gameData && gameData.players) ? gameData.players[1 - state.playerIndex].username : 'Opponent';
        var myName = (gameData && gameData.players) ? gameData.players[state.playerIndex].username : 'You';
        var scores = state.scores || [0, 0];
        var target = state.targetScore || 50;
        var myScore = scores[state.playerIndex];
        var oppScore = scores[1 - state.playerIndex];

        var h = '<div class="domino-screen">';

        h += '<div class="domino-opp-bar">';
        h += '<button class="back-btn" onclick="DominoUI.quit()">&#8592;</button>';
        h += '<div class="domino-opp-center"><div class="domino-opp-top-row">';
        h += '<div class="domino-avatar">' + (oppName ? oppName.charAt(0).toUpperCase() : 'O') + '</div>';
        h += '<span class="domino-score-big">' + oppScore + '/' + target + '</span>';
        h += '</div><div class="domino-name-row"><div class="domino-online-dot"></div>';
        h += '<span class="domino-username">' + oppName + '</span></div></div>';
        h += '<div style="position:relative;"><button class="domino-menu-btn" onclick="DominoUI.toggleMenu(event)">&#8942;</button>';
        h += '<div class="domino-dropdown' + (menuOpen ? ' open' : '') + '">';
        h += '<button class="domino-dropdown-item danger" onclick="DominoUI.resign(event)">Resign</button>';
        h += '</div></div></div>';

        h += '<div class="domino-opp-tiles">';
        for (var i = 0; i < oppCount; i++) h += '<div class="domino-tile-back"></div>';
        h += '</div>';

        var remaining = state.turnRemainingMs || 0;
        var total = state.turnTimeMs || 15000;
        var pct = (remaining / total) * 100;
        var timerCls = pct > 50 ? 'green' : pct > 25 ? 'yellow' : 'red';
        h += '<div class="domino-timer-bar"><div class="domino-timer-fill ' + timerCls + '" style="width:' + pct + '%;"></div></div>';

        h += '<div class="domino-board-area"><div class="domino-board-inner">';
        if (board.length === 0) h += '<span class="domino-chain-empty">Place the first tile!</span>';
        else h += renderSnakeChain(board);
        h += '</div>';

        if (boneCount > 0) {
          h += '<div class="domino-boneyard"><div class="domino-boneyard-stack">';
          var cards = Math.min(boneCount, 4);
          for (var b = 0; b < cards; b++) {
            h += '<div class="domino-boneyard-card" style="top:' + (b * 2) + 'px;left:' + (b * 1) + 'px;"></div>';
          }
          h += '</div><span class="domino-boneyard-count">' + boneCount + '</span></div>';
        }
        h += '</div>';

        if (state.roundOver && !state.gameOver) {
          h += '<div style="position:absolute;inset:0;background:rgba(0,0,0,0.75);display:flex;align-items:center;justify-content:center;z-index:50;">';
          h += '<div style="background:#1e3a8a;border:2px solid #3b82f6;border-radius:16px;padding:1.5rem 2rem;text-align:center;max-width:320px;width:90%;color:#fff;">';
          h += '<h3 style="font-size:1.3rem;margin-bottom:0.8rem;color:#fbbf24;">Round ' + (state.round || 1) + ' Complete</h3>';
          var rwIdx = state.roundWinner;
          if (rwIdx !== null) {
            var rwName = (rwIdx === state.playerIndex) ? myName : oppName;
            h += '<p style="margin-bottom:0.5rem;">' + rwName + ' wins the round!</p>';
            h += '<p style="color:#9ca3af;font-size:0.85rem;margin-bottom:0.3rem;">Pip counts: You ' + (state.pipCounts ? state.pipCounts[state.playerIndex] : 0) + ' &mdash; ' + oppName + ' ' + (state.pipCounts ? state.pipCounts[1 - state.playerIndex] : 0) + '</p>';
            h += '<p style="color:#22c55e;font-size:1.1rem;font-weight:700;">+' + (state.roundPoints || 0) + ' points to ' + rwName + '</p>';
          } else {
            h += '<p>Tie &mdash; no points awarded</p>';
          }
          h += '<p style="margin-top:0.8rem;color:#93c5fd;font-size:0.9rem;">Score: You ' + myScore + ' &mdash; ' + oppName + ' ' + oppScore + '</p>';
          h += '<button onclick="DominoUI.nextRound()" style="margin-top:1rem;background:#22c55e;color:#fff;border:none;border-radius:10px;padding:0.7rem 2rem;font-size:1rem;font-weight:700;cursor:pointer;font-family:inherit;">Next Round</button>';
          h += '</div></div>';
        }

        h += '<div class="domino-my-hand">';
        for (var j = 0; j < hand.length; j++) {
          var sel = j === selectedTileIndex ? ' selected' : '';
          h += '<div class="domino-hand-wrap' + sel + '" onclick="DominoUI.selectTile(' + j + ')">';
          h += renderHandTile(hand[j][0], hand[j][1]);
          h += '</div>';
        }
        h += '</div>';

        h += '<div class="domino-actions">';
        if (isMyTurn && !state.roundOver) {
          if (selectedTileIndex !== null && hand[selectedTileIndex]) {
            var st = hand[selectedTileIndex];
            if (board.length === 0) {
              h += '<button class="side-btn" onclick="DominoUI.playTile(\'right\')">Play Tile</button>';
            } else {
              var mL = st[0] === state.boardLeft || st[1] === state.boardLeft;
              var mR = st[0] === state.boardRight || st[1] === state.boardRight;
              if (mL && mR && state.boardLeft !== state.boardRight) {
                h += '<button class="side-btn" onclick="DominoUI.playTile(\'left\')">&#9664; Left</button>';
                h += '<button class="side-btn" onclick="DominoUI.playTile(\'right\')">Right &#9654;</button>';
              } else if (mL) {
                h += '<button class="side-btn" onclick="DominoUI.playTile(\'left\')">&#9664; Left</button>';
              } else if (mR) {
                h += '<button class="side-btn" onclick="DominoUI.playTile(\'right\')">Right &#9654;</button>';
              } else {
                h += '<span style="color:#fca5a5;font-size:0.8rem;">Doesn\'t match</span>';
              }
            }
          }
        }
        h += '</div>';

        h += '<div class="domino-my-bar">';
        h += '<div class="domino-my-top-row">';
        h += '<div class="domino-avatar my">' + (myName ? myName.charAt(0).toUpperCase() : 'Y') + '</div>';
        h += '<span class="domino-score-big">' + myScore + '/' + target + '</span>';
        h += '</div>';
        h += '<div class="domino-name-row"><div class="domino-online-dot"></div>';
        h += '<span class="domino-username">' + myName + '</span></div>';
        if (!state.roundOver) {
          var pillCls = isMyTurn ? 'active' : 'waiting';
          var pillTxt = isMyTurn ? 'Your Turn' : 'Opponent\'s Turn';
          h += '<div class="domino-turn-pill ' + pillCls + '">' + pillTxt + '</div>';
        }
        h += '</div></div>';

        area.innerHTML = h;
        controls.innerHTML = ''; controls.style.display = 'none';
        if (!state.roundOver && !state.gameOver) startTimer(state);

        if (isMyTurn && !state.roundOver && !state.gameOver && !state.canPlay && state.canDraw) {
          setTimeout(function() { autoDraw(); }, 400);
        }
      }

      function renderSnakeChain(board) {
        var sw = window.innerWidth || 400;
        var TH = sw <= 380 ? 18 : sw <= 480 ? 20 : 28;
        var hW = TH * 2 + 1;
        var hH = TH + 2;
        var vW = TH + 2;
        var vH = TH * 2 + 1;
        var GAP = 1;
        var vOff = Math.round((vH - hH) / 2);

        var screenW = (window.innerWidth || 400);
        var boardW = screenW - 60;

        var positions = [];
        var cx = 0, cy = 0;
        var dir = 1;
        var rowUsed = 0;

        for (var i = 0; i < board.length; i++) {
          var t = board[i], dbl = t[0] === t[1];
          var tw = dbl ? vW : hW;

          var needsTurn = false;
          if (i < board.length - 1 && rowUsed > 0) {
            if (rowUsed + tw + GAP > boardW) {
              needsTurn = true;
            } else {
              var nDbl = board[i + 1][0] === board[i + 1][1];
              var nTw = nDbl ? vW : hW;
              if (rowUsed + tw + GAP + nTw + GAP > boardW) {
                needsTurn = true;
              }
            }
          }

          if (needsTurn) {
            var ty = cy - vOff;
            var tx;
            if (dir === 1) {
              tx = cx;
              positions.push({ a: t[0], b: t[1], x: tx, y: ty, o: 'v', d: 0 });
              cx = tx + vW;
            } else {
              tx = cx - vW;
              positions.push({ a: t[0], b: t[1], x: tx, y: ty, o: 'v', d: 0 });
              cx = tx;
            }
            cy = ty + vH + 6;
            dir = -dir;
            rowUsed = 0;
            continue;
          }

          if (dbl) {
            var dy = cy - vOff;
            if (dir === 1) {
              positions.push({ a: t[0], b: t[1], x: cx, y: dy, o: 'v', d: dir });
              cx += vW + GAP;
            } else {
              positions.push({ a: t[0], b: t[1], x: cx - vW, y: dy, o: 'v', d: dir });
              cx -= vW + GAP;
            }
          } else {
            if (dir === 1) {
              positions.push({ a: t[0], b: t[1], x: cx, y: cy, o: 'h', d: dir });
              cx += hW + GAP;
            } else {
              positions.push({ a: t[0], b: t[1], x: cx - hW, y: cy, o: 'h', d: dir });
              cx -= hW + GAP;
            }
          }
          rowUsed += tw + GAP;
        }

        var mnx = 1e9, mxx = -1e9, mny = 1e9, mxy = -1e9;
        for (var p = 0; p < positions.length; p++) {
          var q = positions[p];
          var pw = q.o === 'h' ? hW : vW;
          var ph = q.o === 'h' ? hH : vH;
          if (q.x < mnx) mnx = q.x;
          if (q.x + pw > mxx) mxx = q.x + pw;
          if (q.y < mny) mny = q.y;
          if (q.y + ph > mxy) mxy = q.y + ph;
        }
        var cw = mxx - mnx + 6, ch = mxy - mny + 6;
        var html = '<div class="domino-board-canvas" style="width:' + cw + 'px;height:' + ch + 'px;">';
        for (var k = 0; k < positions.length; k++) {
          var tp = positions[k];
          var pa = tp.a, pb = tp.b;
          if (tp.d === -1 && tp.o === 'h') { pa = tp.b; pb = tp.a; }
          html += '<div class="dtile-board" style="left:' + (tp.x - mnx + 3) + 'px;top:' + (tp.y - mny + 3) + 'px;">';
          html += renderDominoTile(pa, pb, tp.o, '');
          html += '</div>';
        }
        return html + '</div>';
      }

      function selectTile(idx) {
        selectedTileIndex = selectedTileIndex === idx ? null : idx;
        if (lastState && sendActionFn) render(lastState, sendActionFn, DominoUI._gameData);
      }
      function playTile(side) {
        if (selectedTileIndex === null || !sendActionFn) return;
        GameSounds.place();
        sendActionFn({ type: 'play', tileIndex: selectedTileIndex, side: side });
        selectedTileIndex = null;
      }
      function autoDraw() { if (sendActionFn) sendActionFn({ type: 'auto_draw' }); }
      function nextRound() { if (sendActionFn) sendActionFn({ type: 'next_round' }); selectedTileIndex = null; menuOpen = false; }
      function quit() { if (confirm('Leave the game? You will forfeit.')) window.location.reload(); }
      function resign(e) {
        if (e) { e.stopPropagation(); e.preventDefault(); }
        menuOpen = false;
        if (confirm('Are you sure you want to resign? You will lose the game.')) {
          if (sendActionFn) sendActionFn({ type: 'resign' });
        }
      }
      function toggleMenu(e) {
        if (e) { e.stopPropagation(); e.preventDefault(); }
        menuOpen = !menuOpen;
        var dd = document.querySelector('.domino-dropdown');
        if (dd) dd.classList.toggle('open', menuOpen);
      }

      document.addEventListener('click', function(e) {
        if (menuOpen && !e.target.closest('.domino-menu-btn')) {
          menuOpen = false;
          var dd = document.querySelector('.domino-dropdown');
          if (dd) dd.classList.remove('open');
        }
      });

      return {
        render: function(state, sendAction, gd) { DominoUI._gameData = gd; render(state, sendAction, gd); },
        selectTile: selectTile, playTile: playTile, autoDraw: autoDraw, nextRound: nextRound,
        quit: quit, resign: resign, toggleMenu: toggleMenu,
        _gameData: null
      };
    })();

    // ════════════════════════════════════════
    // TIC TAC TOE UI
    // ════════════════════════════════════════
    var TicTacToeUI = (function() {
      var sendActionFn = null;

      function render(state, sendAction) {
        sendActionFn = sendAction;
        var area = document.getElementById('game-area');
        var board = state.board, size = state.size || 3, symbol = state.symbol;
        var winLen = state.winLength || (size <= 3 ? 3 : 4);
        var cellSize = size <= 3 ? 100 : (size <= 5 ? 70 : 54);
        var fontSize = size <= 3 ? '2.5rem' : (size <= 5 ? '1.6rem' : '1.2rem');

        var html = '<div><p style="text-align:center;margin-bottom:0.8rem;color:#9ca3af;">You are <strong style="color:' +
          (symbol === 'X' ? '#00d4aa' : '#ffc107') + ';font-size:1.3rem;">' + symbol + '</strong> &mdash; get <strong>' + winLen + '</strong> in a row to win</p>';
        html += '<div class="ttt-grid" style="grid-template-columns:repeat(' + size + ',' + cellSize + 'px);grid-template-rows:repeat(' + size + ',' + cellSize + 'px);">';
        for (var i = 0; i < board.length; i++) {
          var val = board[i], cls = 'ttt-cell', content = '';
          if (val === 0) { cls += ' x taken'; content = 'X'; }
          else if (val === 1) { cls += ' o taken'; content = 'O'; }
          var onclick = val === null && state.isMyTurn ? ' onclick="TicTacToeUI.placeAt(' + i + ')"' : '';
          html += '<div class="' + cls + '" style="font-size:' + fontSize + ';"' + onclick + '>' + content + '</div>';
        }
        html += '</div></div>';
        area.innerHTML = html;

        var controls = document.getElementById('game-controls');
        controls.innerHTML = state.isMyTurn
          ? '<p style="text-align:center;color:#00c853;font-weight:600;">Click a cell to place your mark!</p>'
          : '<p style="text-align:center;color:#9ca3af;">Waiting for opponent to play...</p>';
      }

      function placeAt(cell) { GameSounds.place(); if (sendActionFn) sendActionFn({ type: 'place', cell: cell }); }
      return { render: render, placeAt: placeAt };
    })();

    // ════════════════════════════════════════
    // MANCALA UI
    // ════════════════════════════════════════
    var MancalaUI = (function() {
      var sendActionFn = null;
      var menuOpen = false;
      var timerInterval = null;
      var animating = false;
      var lastState = null;
      var lastGameData = null;

      function startTimer(state) {
        if (timerInterval) clearInterval(timerInterval);
        var startRemaining = state.turnRemainingMs || 0;
        var total = state.turnTimeMs || 20000;
        var startTs = Date.now();
        timerInterval = setInterval(function() {
          var elapsed = Date.now() - startTs;
          var rem = Math.max(0, startRemaining - elapsed);
          var pct = (rem / total) * 100;
          var fill = document.querySelector('.mancala-timer-fill');
          if (fill) {
            fill.style.width = pct + '%';
            fill.className = 'mancala-timer-fill ' + (pct > 50 ? 'green' : pct > 25 ? 'yellow' : 'red');
          }
          if (rem <= 0) clearInterval(timerInterval);
        }, 500);
      }

      function pitDataAttr(pitIdx) { return 'data-pit="' + pitIdx + '"'; }

      function render(state, sendAction, gameData) {
        if (animating) { lastState = state; lastGameData = gameData; sendActionFn = sendAction; return; }
        sendActionFn = sendAction;
        lastState = state;
        lastGameData = gameData;
        _renderBoard(state, gameData);
      }

      function _renderBoard(state, gameData) {
        var area = document.getElementById('game-area');
        var controls = document.getElementById('game-controls');
        var pits = state.pits;
        var isMyTurn = state.isMyTurn && !animating;
        var oppName = (gameData && gameData.players) ? gameData.players[1 - state.playerIndex].username : 'Opponent';
        var myName = (gameData && gameData.players) ? gameData.players[state.playerIndex].username : 'You';

        var h = '<div class="mancala-screen">';

        h += '<div class="mancala-topbar">';
        h += '<button class="back-btn" onclick="MancalaUI.quit()">&#8592;</button>';
        h += '<div class="mancala-player-info"><div class="name">' + oppName + '</div>';
        h += '<div class="score">' + state.scores[1 - state.playerIndex] + '</div></div>';
        h += '<div class="mancala-menu-wrap"><button class="mancala-menu-btn" onclick="MancalaUI.toggleMenu(event)">&#8942;</button>';
        h += '<div class="domino-dropdown' + (menuOpen ? ' open' : '') + '">';
        h += '<button class="domino-dropdown-item danger" onclick="MancalaUI.resign(event)">Resign</button>';
        h += '</div></div></div>';

        var remaining = state.turnRemainingMs || 0;
        var total = state.turnTimeMs || 20000;
        var pct = (remaining / total) * 100;
        var timerCls = pct > 50 ? 'green' : pct > 25 ? 'yellow' : 'red';
        h += '<div class="mancala-timer"><div class="mancala-timer-fill ' + timerCls + '" style="width:' + pct + '%;"></div></div>';

        h += '<div class="mancala-board-wrap"><div class="mancala-board">';

        var oppStore, myStore, oppPits, myPits;
        if (state.playerIndex === 0) {
          oppStore = 13; myStore = 6;
          oppPits = [12, 11, 10, 9, 8, 7];
          myPits = [0, 1, 2, 3, 4, 5];
        } else {
          oppStore = 6; myStore = 13;
          oppPits = [5, 4, 3, 2, 1, 0];
          myPits = [7, 8, 9, 10, 11, 12];
        }

        h += '<div class="mancala-store" ' + pitDataAttr(oppStore) + ' style="grid-column:1;grid-row:1/3;">';
        h += '<div class="mancala-store-label">' + oppName.charAt(0) + '</div>';
        h += '<div class="mancala-store-count">' + pits[oppStore] + '</div>';
        h += renderSeeds(pits[oppStore], true, 's-opp');
        h += '</div>';

        for (var i = 0; i < 6; i++) {
          var pi = oppPits[i];
          h += '<div class="mancala-pit disabled" ' + pitDataAttr(pi) + ' style="grid-column:' + (i + 2) + ';grid-row:1;">';
          h += renderSeeds(pits[pi], false, 's-opp');
          h += '<div class="mancala-pit-count">' + pits[pi] + '</div></div>';
        }

        for (var j = 0; j < 6; j++) {
          var pj = myPits[j];
          var canClick = isMyTurn && pits[pj] > 0 && !state.gameOver;
          var cls = canClick ? '' : ' disabled';
          var click = canClick ? ' onclick="MancalaUI.sow(' + pj + ')"' : '';
          h += '<div class="mancala-pit' + cls + '" ' + pitDataAttr(pj) + ' style="grid-column:' + (j + 2) + ';grid-row:2;"' + click + '>';
          h += renderSeeds(pits[pj], false, 's-me');
          h += '<div class="mancala-pit-count">' + pits[pj] + '</div></div>';
        }

        h += '<div class="mancala-store" ' + pitDataAttr(myStore) + ' style="grid-column:8;grid-row:1/3;">';
        h += '<div class="mancala-store-label">' + myName.charAt(0) + '</div>';
        h += '<div class="mancala-store-count">' + pits[myStore] + '</div>';
        h += renderSeeds(pits[myStore], true, 's-me');
        h += '</div>';

        h += '</div></div>';

        h += '<div style="text-align:center;padding:0.5rem;">';
        h += '<div class="mancala-player-info"><div class="name">' + myName + '</div>';
        h += '<div class="score">' + state.scores[state.playerIndex] + '</div></div>';
        var pillCls = isMyTurn ? 'active' : 'waiting';
        var pillTxt = isMyTurn ? 'Your Turn' : "Opponent's Turn";
        h += '<div class="mancala-turn-pill ' + pillCls + '">' + pillTxt + '</div>';
        h += '</div></div>';

        area.innerHTML = h;
        controls.innerHTML = ''; controls.style.display = 'none';
        if (!state.gameOver) startTimer(state);
      }

      function renderSeeds(count, isStore, colorCls) {
        if (count === 0) return '';
        var max = isStore ? 24 : 10;
        var show = Math.min(count, max);
        var cls = colorCls || 's-mix';
        var h = '<div class="mancala-seeds">';
        for (var i = 0; i < show; i++) h += '<div class="mancala-seed ' + cls + '"></div>';
        h += '</div>';
        return h;
      }

      function getPitCenter(pitIdx) {
        var el = document.querySelector('[data-pit="' + pitIdx + '"]');
        if (!el) return null;
        var r = el.getBoundingClientRect();
        return { x: r.left + r.width / 2, y: r.top + r.height / 2 };
      }

      function sow(pit) {
        if (!sendActionFn || animating) return;
        if (!lastState) { sendActionFn({ type: 'sow', pit: pit }); return; }

        var pits = lastState.pits.slice();
        var seeds = pits[pit];
        if (seeds === 0) return;

        var playerIndex = lastState.playerIndex;
        var oppStoreIdx = playerIndex === 0 ? 13 : 6;

        var path = [];
        var pos = pit;
        pits[pit] = 0;
        for (var i = 0; i < seeds; i++) {
          pos = (pos + 1) % 14;
          if (pos === oppStoreIdx) pos = (pos + 1) % 14;
          path.push(pos);
          pits[pos]++;
        }

        var fromCenter = getPitCenter(pit);
        if (!fromCenter) { sendActionFn({ type: 'sow', pit: pit }); return; }

        animating = true;
        _renderBoard(Object.assign({}, lastState, { pits: lastState.pits.slice() }), lastGameData);

        var srcEl = document.querySelector('[data-pit="' + pit + '"]');
        if (srcEl) {
          var seedEls = srcEl.querySelectorAll('.mancala-seed');
          for (var s = 0; s < seedEls.length; s++) seedEls[s].style.opacity = '0.3';
          var countEl = srcEl.querySelector('.mancala-pit-count');
          if (countEl) countEl.textContent = '0';
        }

        var delay = 0;
        var INTERVAL = 180;
        var myStore = playerIndex === 0 ? 6 : 13;

        for (var j = 0; j < path.length; j++) {
          (function(targetPit, idx) {
            setTimeout(function() {
              var to = getPitCenter(targetPit);
              if (!to) { finishIfLast(idx); return; }

              var seed = document.createElement('div');
              seed.className = 'mancala-flying-seed s-me';
              seed.style.left = fromCenter.x - 6 + 'px';
              seed.style.top = fromCenter.y - 6 + 'px';
              document.body.appendChild(seed);

              requestAnimationFrame(function() {
                seed.style.left = (to.x - 6 + (Math.random() - 0.5) * 10) + 'px';
                seed.style.top = (to.y - 6 + (Math.random() - 0.5) * 10) + 'px';
              });

              if (targetPit === myStore) GameSounds.seedStore();
              else GameSounds.seedDrop();

              setTimeout(function() {
                if (seed.parentNode) seed.parentNode.removeChild(seed);

                var tgtEl = document.querySelector('[data-pit="' + targetPit + '"]');
                if (tgtEl) {
                  var sc = tgtEl.querySelector('.mancala-store-count') || tgtEl.querySelector('.mancala-pit-count');
                  if (sc) sc.textContent = parseInt(sc.textContent || '0') + 1;
                }

                finishIfLast(idx);
              }, 280);
            }, delay);
          })(path[j], j);
          delay += INTERVAL;
        }

        function finishIfLast(idx) {
          if (idx === path.length - 1) {
            setTimeout(function() {
              animating = false;
              if (sendActionFn) sendActionFn({ type: 'sow', pit: pit });
            }, 200);
          }
        }
      }

      function quit() { if (confirm('Leave? You forfeit.')) window.location.reload(); }
      function resign(e) {
        if (e) { e.stopPropagation(); e.preventDefault(); }
        menuOpen = false;
        if (confirm('Resign this game?')) { GameSounds.resign(); if (sendActionFn) sendActionFn({ type: 'resign' }); }
      }
      function toggleMenu(e) { if (e) e.stopPropagation(); menuOpen = !menuOpen; GameSounds.click(); }

      document.addEventListener('click', function() { menuOpen = false; });

      return { render: render, sow: sow, quit: quit, resign: resign, toggleMenu: toggleMenu };
    })();

    // ════════════════════════════════════════
    // CHECKERS UI
    // ════════════════════════════════════════
    var CheckersUI = (function() {
      var sendActionFn = null;
      var selectedSquare = null;
      var legalMoves = [];
      var menuOpen = false;
      var timerInterval = null;
      var lastState = null;

      function startTimer(state) {
        if (timerInterval) clearInterval(timerInterval);
        var startRemaining = state.turnRemainingMs || 0;
        var total = state.turnTimeMs || 30000;
        var startTs = Date.now();
        timerInterval = setInterval(function() {
          var elapsed = Date.now() - startTs;
          var rem = Math.max(0, startRemaining - elapsed);
          var pct = (rem / total) * 100;
          var fill = document.querySelector('.checkers-timer-fill');
          if (fill) {
            fill.style.width = pct + '%';
            fill.className = 'checkers-timer-fill ' + (pct > 50 ? 'green' : pct > 25 ? 'yellow' : 'red');
          }
          if (rem <= 0) clearInterval(timerInterval);
        }, 500);
      }

      function computeMoves(state, from) {
        var piece = state.board[from];
        if (!piece || piece.player !== state.playerIndex) return [];
        var moves = [];
        var dirs = piece.king
          ? [[-1,-1],[-1,1],[1,-1],[1,1]]
          : piece.player === 0 ? [[-1,-1],[-1,1]] : [[1,-1],[1,1]];
        var r = Math.floor(from / 8), c = from % 8;

        var jumps = [];
        for (var d = 0; d < dirs.length; d++) {
          var dr = dirs[d][0], dc = dirs[d][1];
          var mr = r + dr, mc = c + dc, lr = r + 2 * dr, lc = c + 2 * dc;
          if (lr < 0 || lr > 7 || lc < 0 || lc > 7) continue;
          var mid = state.board[mr * 8 + mc];
          var land = state.board[lr * 8 + lc];
          if (mid && mid.player !== piece.player && !land) jumps.push(lr * 8 + lc);
        }

        var hasAnyJumps = false;
        if (state.mustJumpFrom !== null) {
          hasAnyJumps = true;
        } else {
          for (var i = 0; i < 64 && !hasAnyJumps; i++) {
            var p = state.board[i];
            if (p && p.player === state.playerIndex) {
              var pd = p.king ? [[-1,-1],[-1,1],[1,-1],[1,1]] : (p.player === 0 ? [[-1,-1],[-1,1]] : [[1,-1],[1,1]]);
              var pr = Math.floor(i / 8), pc2 = i % 8;
              for (var d2 = 0; d2 < pd.length; d2++) {
                var mr2 = pr + pd[d2][0], mc2 = pc2 + pd[d2][1];
                var lr2 = pr + 2 * pd[d2][0], lc2 = pc2 + 2 * pd[d2][1];
                if (lr2 >= 0 && lr2 <= 7 && lc2 >= 0 && lc2 <= 7) {
                  var mid2 = state.board[mr2 * 8 + mc2], land2 = state.board[lr2 * 8 + lc2];
                  if (mid2 && mid2.player !== state.playerIndex && !land2) { hasAnyJumps = true; break; }
                }
              }
            }
          }
        }

        if (hasAnyJumps) return jumps;

        for (var d3 = 0; d3 < dirs.length; d3++) {
          var nr = r + dirs[d3][0], nc = c + dirs[d3][1];
          if (nr >= 0 && nr <= 7 && nc >= 0 && nc <= 7 && !state.board[nr * 8 + nc]) {
            moves.push(nr * 8 + nc);
          }
        }
        return moves;
      }

      function render(state, sendAction, gameData) {
        sendActionFn = sendAction;
        lastState = state;
        var area = document.getElementById('game-area');
        var controls = document.getElementById('game-controls');
        var board = state.board;
        var isMyTurn = state.isMyTurn;
        var oppName = (gameData && gameData.players) ? gameData.players[1 - state.playerIndex].username : 'Opponent';
        var myName = (gameData && gameData.players) ? gameData.players[state.playerIndex].username : 'You';
        var flip = state.playerIndex === 1;

        var h = '<div class="checkers-screen">';

        h += '<div class="checkers-topbar">';
        h += '<button class="back-btn" data-checkers-action="quit">&#8592;</button>';
        h += '<div class="checkers-player-info"><div class="name">' + oppName + '</div>';
        h += '<div class="pieces-count">Pieces: ' + state.pieces[1 - state.playerIndex] + '</div></div>';
        h += '<div class="checkers-menu-wrap"><button class="checkers-menu-btn" data-checkers-action="menu">&#8942;</button>';
        h += '<div class="domino-dropdown' + (menuOpen ? ' open' : '') + '">';
        h += '<button class="domino-dropdown-item danger" data-checkers-action="resign">Resign</button>';
        h += '</div></div></div>';

        var remaining = state.turnRemainingMs || 0;
        var total = state.turnTimeMs || 30000;
        var pct = (remaining / total) * 100;
        var timerCls = pct > 50 ? 'green' : pct > 25 ? 'yellow' : 'red';
        h += '<div class="checkers-timer"><div class="checkers-timer-fill ' + timerCls + '" style="width:' + pct + '%;"></div></div>';

        h += '<div class="checkers-board-wrap"><div class="checkers-board">';

        for (var idx = 0; idx < 64; idx++) {
          var viewIdx = flip ? 63 - idx : idx;
          var r = Math.floor(viewIdx / 8), c = viewIdx % 8;
          var isDark = (r + c) % 2 === 1;
          var sq = board[viewIdx];
          var isSelected = selectedSquare === viewIdx;
          var isLegal = legalMoves.indexOf(viewIdx) >= 0;

          var cls = 'checkers-sq ' + (isDark ? 'dark' : 'light');
          if (isSelected) cls += ' selected';
          if (isLegal) cls += ' highlight';

          var dataAttr = '';
          if (isLegal && isMyTurn) {
            dataAttr = ' data-checkers-move="' + viewIdx + '"';
          } else if (sq && sq.player === state.playerIndex && isMyTurn) {
            dataAttr = ' data-checkers-select="' + viewIdx + '"';
          }

          h += '<div class="' + cls + '"' + dataAttr + '>';
          if (sq) {
            var pcls = 'checkers-piece p' + sq.player;
            if (sq.king) pcls += ' king';
            if (sq.player === state.playerIndex && isMyTurn) pcls += ' selectable';
            h += '<div class="' + pcls + '"></div>';
          }
          h += '</div>';
        }

        h += '</div></div>';

        h += '<div style="text-align:center;padding:0.5rem;">';
        h += '<div class="checkers-player-info"><div class="name">' + myName + '</div>';
        h += '<div class="pieces-count">Pieces: ' + state.pieces[state.playerIndex] + '</div></div>';
        var pillCls = isMyTurn ? 'active' : 'waiting';
        var pillTxt = isMyTurn ? 'Your Turn' : "Opponent's Turn";
        h += '<div class="checkers-turn-pill ' + pillCls + '">' + pillTxt + '</div>';
        h += '</div></div>';

        area.innerHTML = h;
        controls.innerHTML = ''; controls.style.display = 'none';

        var boardEl = area.querySelector('.checkers-board');
        if (boardEl) {
          boardEl.addEventListener('click', function(e) {
            var cell = e.target.closest('[data-checkers-move], [data-checkers-select]');
            if (!cell) return;
            e.stopPropagation();
            if (cell.hasAttribute('data-checkers-move')) {
              moveTo(parseInt(cell.getAttribute('data-checkers-move')));
            } else if (cell.hasAttribute('data-checkers-select')) {
              selectPiece(parseInt(cell.getAttribute('data-checkers-select')));
            }
          });
        }

        var screenEl = area.querySelector('.checkers-screen');
        if (screenEl) {
          screenEl.addEventListener('click', function(e) {
            var btn = e.target.closest('[data-checkers-action]');
            if (!btn) return;
            e.stopPropagation();
            var action = btn.getAttribute('data-checkers-action');
            if (action === 'quit') quit();
            else if (action === 'menu') toggleMenu(e);
            else if (action === 'resign') resign(e);
          });
        }

        if (!state.gameOver) startTimer(state);
      }

      function selectPiece(sq) {
        if (!lastState || !lastState.isMyTurn) return;
        if (lastState.mustJumpFrom !== null && sq !== lastState.mustJumpFrom) return;
        selectedSquare = sq;
        legalMoves = computeMoves(lastState, sq);
        render(lastState, sendActionFn, CheckersUI._gameData);
      }

      function moveTo(sq) {
        if (sendActionFn && selectedSquare !== null) {
          var isJump = Math.abs(Math.floor(selectedSquare/8) - Math.floor(sq/8)) === 2;
          if (isJump) GameSounds.jump(); else GameSounds.move();
          sendActionFn({ type: 'move', from: selectedSquare, to: sq });
          selectedSquare = null;
          legalMoves = [];
        }
      }

      function quit() { if (confirm('Leave? You forfeit.')) window.location.reload(); }
      function resign(e) {
        if (e) { e.stopPropagation(); e.preventDefault(); }
        menuOpen = false;
        if (confirm('Resign this game?')) { GameSounds.resign(); if (sendActionFn) sendActionFn({ type: 'resign' }); }
      }
      function toggleMenu(e) { if (e) e.stopPropagation(); menuOpen = !menuOpen; GameSounds.click(); }

      document.addEventListener('click', function() { menuOpen = false; });

      return { render: render, selectPiece: selectPiece, moveTo: moveTo, quit: quit, resign: resign, toggleMenu: toggleMenu, _gameData: null };
    })();

    // ════════════════════════════════════════
    // CHESS UI
    // ════════════════════════════════════════
    var ChessUI = (function() {
      var sendActionFn = null;
      var selectedSquare = null;
      var legalMoves = [];
      var menuOpen = false;
      var timerInterval = null;
      var lastState = null;
      var promotionPending = null;

      var PIECE_UNICODE = {
        K: ['\u2654', '\u265A'], Q: ['\u2655', '\u265B'], R: ['\u2656', '\u265C'],
        B: ['\u2657', '\u265D'], N: ['\u2658', '\u265E'], P: ['\u2659', '\u265F']
      };

      function startTimer(state) {
        if (timerInterval) clearInterval(timerInterval);
        var startRemaining = state.turnRemainingMs || 0;
        var total = state.turnTimeMs || 60000;
        var startTs = Date.now();
        timerInterval = setInterval(function() {
          var elapsed = Date.now() - startTs;
          var rem = Math.max(0, startRemaining - elapsed);
          var pct = (rem / total) * 100;
          var fill = document.querySelector('.chess-timer-fill');
          if (fill) {
            fill.style.width = pct + '%';
            fill.className = 'chess-timer-fill ' + (pct > 50 ? 'green' : pct > 25 ? 'yellow' : 'red');
          }
          if (rem <= 0) clearInterval(timerInterval);
        }, 500);
      }

      function render(state, sendAction, gameData) {
        sendActionFn = sendAction;
        lastState = state;
        var area = document.getElementById('game-area');
        var controls = document.getElementById('game-controls');
        var board = state.board;
        var isMyTurn = state.isMyTurn;
        var oppName = (gameData && gameData.players) ? gameData.players[1 - state.playerIndex].username : 'Opponent';
        var myName = (gameData && gameData.players) ? gameData.players[state.playerIndex].username : 'You';
        var flip = state.playerIndex === 1;
        var lastMove = state.lastMove;
        var kingPos = -1;
        if (state.inCheck) {
          for (var k = 0; k < 64; k++) {
            if (board[k] && board[k].type === 'K' && board[k].player === state.currentPlayer) { kingPos = k; break; }
          }
        }

        var h = '<div class="chess-screen">';

        h += '<div class="chess-topbar">';
        h += '<button class="back-btn" data-chess-action="quit">&#8592;</button>';
        h += '<div class="chess-player-info"><div class="name">' + oppName + '</div>';
        h += '<div class="material">Material: ' + state.material[1 - state.playerIndex] + '</div></div>';
        h += '<div class="chess-menu-wrap"><button class="chess-menu-btn" data-chess-action="menu">&#8942;</button>';
        h += '<div class="domino-dropdown' + (menuOpen ? ' open' : '') + '">';
        h += '<button class="domino-dropdown-item danger" data-chess-action="resign">Resign</button>';
        h += '</div></div></div>';

        var remaining = state.turnRemainingMs || 0;
        var total = state.turnTimeMs || 60000;
        var pct = (remaining / total) * 100;
        var timerCls = pct > 50 ? 'green' : pct > 25 ? 'yellow' : 'red';
        h += '<div class="chess-timer"><div class="chess-timer-fill ' + timerCls + '" style="width:' + pct + '%;"></div></div>';

        h += '<div class="chess-board-wrap"><div class="chess-board">';

        for (var idx = 0; idx < 64; idx++) {
          var viewIdx = flip ? 63 - idx : idx;
          var r = Math.floor(viewIdx / 8), c = viewIdx % 8;
          var isLight = (r + c) % 2 === 0;
          var sq = board[viewIdx];
          var isSelected = selectedSquare === viewIdx;
          var isLegal = legalMoves.indexOf(viewIdx) >= 0;
          var isLastMove = lastMove && (viewIdx === lastMove.from || viewIdx === lastMove.to);

          var cls = 'chess-sq ' + (isLight ? 'light' : 'dark');
          if (isSelected) cls += ' selected';
          else if (isLastMove) cls += ' last-move';
          if (isLegal) {
            cls += ' highlight';
            if (sq) cls += ' has-piece';
          }
          if (viewIdx === kingPos) cls += ' in-check';

          var dataAttr = '';
          if (isLegal && isMyTurn) {
            dataAttr = ' data-chess-move="' + viewIdx + '"';
          } else if (sq && sq.player === state.playerIndex && isMyTurn) {
            dataAttr = ' data-chess-select="' + viewIdx + '"';
          }

          h += '<div class="' + cls + '"' + dataAttr + '>';
          if (sq) {
            var unicode = PIECE_UNICODE[sq.type][sq.player];
            var pieceColor = sq.player === 0 ? 'white-piece' : 'black-piece';
            h += '<span class="chess-piece ' + pieceColor + '">' + unicode + '</span>';
          }
          h += '</div>';
        }

        h += '</div></div>';

        h += '<div style="text-align:center;padding:0.5rem;">';
        h += '<div class="chess-player-info"><div class="name">' + myName + '</div>';
        h += '<div class="material">Material: ' + state.material[state.playerIndex] + '</div></div>';
        var pillCls = isMyTurn ? 'active' : 'waiting';
        var pillTxt = isMyTurn ? 'Your Turn' : "Opponent's Turn";
        if (state.inCheck && isMyTurn) pillTxt = 'Check!';
        h += '<div class="chess-turn-pill ' + pillCls + '">' + pillTxt + '</div>';
        h += '</div></div>';

        if (promotionPending !== null) {
          h += '<div class="chess-promo-overlay">';
          h += '<div class="chess-promo-box">';
          var promoPlayer = state.playerIndex;
          var promoPieces = ['Q', 'R', 'B', 'N'];
          for (var pi = 0; pi < promoPieces.length; pi++) {
            var pp = promoPieces[pi];
            h += '<div class="chess-promo-btn" data-chess-promote="' + pp + '">' + PIECE_UNICODE[pp][promoPlayer] + '</div>';
          }
          h += '</div></div>';
        }

        area.innerHTML = h;
        controls.innerHTML = ''; controls.style.display = 'none';

        var boardEl = area.querySelector('.chess-board');
        if (boardEl) {
          boardEl.addEventListener('click', function(e) {
            var cell = e.target.closest('[data-chess-move], [data-chess-select]');
            if (!cell) return;
            e.stopPropagation();
            if (cell.hasAttribute('data-chess-move')) {
              moveTo(parseInt(cell.getAttribute('data-chess-move')));
            } else if (cell.hasAttribute('data-chess-select')) {
              selectPiece(parseInt(cell.getAttribute('data-chess-select')));
            }
          });
        }

        var promoBox = area.querySelector('.chess-promo-box');
        if (promoBox) {
          promoBox.addEventListener('click', function(e) {
            var btn = e.target.closest('[data-chess-promote]');
            if (!btn) return;
            promote(btn.getAttribute('data-chess-promote'));
          });
        }

        var screenEl = area.querySelector('.chess-screen');
        if (screenEl) {
          screenEl.addEventListener('click', function(e) {
            var btn = e.target.closest('[data-chess-action]');
            if (!btn) return;
            e.stopPropagation();
            var action = btn.getAttribute('data-chess-action');
            if (action === 'quit') quit();
            else if (action === 'menu') toggleMenu(e);
            else if (action === 'resign') resign(e);
          });
        }

        if (!state.gameOver) startTimer(state);
      }

      function selectPiece(sq) {
        if (!lastState || !lastState.isMyTurn) return;
        selectedSquare = sq;
        legalMoves = computeLegalMoves(lastState, sq);
        render(lastState, sendActionFn, ChessUI._gameData);
      }

      function computeLegalMoves(state, from) {
        var piece = state.board[from];
        if (!piece || piece.player !== state.playerIndex) return [];
        var moves = [];
        var r = Math.floor(from / 8), c = from % 8;

        var addSlide = function(dirs) {
          for (var d = 0; d < dirs.length; d++) {
            for (var s = 1; s < 8; s++) {
              var nr = r + dirs[d][0] * s, nc = c + dirs[d][1] * s;
              if (nr < 0 || nr > 7 || nc < 0 || nc > 7) break;
              var tgt = state.board[nr * 8 + nc];
              if (tgt) { if (tgt.player !== piece.player) moves.push(nr * 8 + nc); break; }
              moves.push(nr * 8 + nc);
            }
          }
        };

        switch (piece.type) {
          case 'P': {
            var dir = piece.player === 0 ? -1 : 1;
            var startRow = piece.player === 0 ? 6 : 1;
            var nr = r + dir;
            if (nr >= 0 && nr <= 7 && !state.board[nr * 8 + c]) {
              moves.push(nr * 8 + c);
              if (r === startRow && !state.board[(r + 2 * dir) * 8 + c]) moves.push((r + 2 * dir) * 8 + c);
            }
            for (var dc = -1; dc <= 1; dc += 2) {
              var nc = c + dc;
              if (nc >= 0 && nc <= 7 && nr >= 0 && nr <= 7) {
                var tgt = state.board[nr * 8 + nc];
                if (tgt && tgt.player !== piece.player) moves.push(nr * 8 + nc);
              }
            }
            break;
          }
          case 'N': {
            var nMoves = [[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]];
            for (var n = 0; n < nMoves.length; n++) {
              var nr2 = r + nMoves[n][0], nc2 = c + nMoves[n][1];
              if (nr2 >= 0 && nr2 <= 7 && nc2 >= 0 && nc2 <= 7) {
                var tgt2 = state.board[nr2 * 8 + nc2];
                if (!tgt2 || tgt2.player !== piece.player) moves.push(nr2 * 8 + nc2);
              }
            }
            break;
          }
          case 'B': addSlide([[-1,-1],[-1,1],[1,-1],[1,1]]); break;
          case 'R': addSlide([[-1,0],[1,0],[0,-1],[0,1]]); break;
          case 'Q': addSlide([[-1,-1],[-1,1],[1,-1],[1,1],[-1,0],[1,0],[0,-1],[0,1]]); break;
          case 'K': {
            var kMoves = [[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];
            for (var km = 0; km < kMoves.length; km++) {
              var nr3 = r + kMoves[km][0], nc3 = c + kMoves[km][1];
              if (nr3 >= 0 && nr3 <= 7 && nc3 >= 0 && nc3 <= 7) {
                var tgt3 = state.board[nr3 * 8 + nc3];
                if (!tgt3 || tgt3.player !== piece.player) moves.push(nr3 * 8 + nc3);
              }
            }
            if (c === 4) {
              if (!state.board[r * 8 + 5] && !state.board[r * 8 + 6]) {
                var kr = state.board[r * 8 + 7];
                if (kr && kr.type === 'R' && kr.player === piece.player) moves.push(r * 8 + 6);
              }
              if (!state.board[r * 8 + 1] && !state.board[r * 8 + 2] && !state.board[r * 8 + 3]) {
                var qr = state.board[r * 8 + 0];
                if (qr && qr.type === 'R' && qr.player === piece.player) moves.push(r * 8 + 2);
              }
            }
            break;
          }
        }
        return moves;
      }

      function moveTo(sq) {
        if (!lastState || selectedSquare === null) return;
        var piece = lastState.board[selectedSquare];
        if (piece && piece.type === 'P') {
          var toRow = Math.floor(sq / 8);
          var promoRow = piece.player === 0 ? 0 : 7;
          if (toRow === promoRow) {
            promotionPending = { from: selectedSquare, to: sq };
            render(lastState, sendActionFn, ChessUI._gameData);
            return;
          }
        }
        var captured = lastState.board[sq];
        if (captured) GameSounds.capture(); else GameSounds.move();
        if (sendActionFn) sendActionFn({ type: 'move', from: selectedSquare, to: sq });
        selectedSquare = null; legalMoves = [];
      }

      function promote(pieceType) {
        if (promotionPending && sendActionFn) {
          GameSounds.king();
          sendActionFn({ type: 'move', from: promotionPending.from, to: promotionPending.to, promotion: pieceType });
          promotionPending = null; selectedSquare = null; legalMoves = [];
        }
      }

      function quit() { if (confirm('Leave? You forfeit.')) window.location.reload(); }
      function resign(e) {
        if (e) { e.stopPropagation(); e.preventDefault(); }
        menuOpen = false;
        if (confirm('Resign this game?')) { if (sendActionFn) sendActionFn({ type: 'resign' }); }
      }
      function toggleMenu(e) { if (e) e.stopPropagation(); menuOpen = !menuOpen; }

      document.addEventListener('click', function() { menuOpen = false; });

      return {
        render: render, selectPiece: selectPiece, moveTo: moveTo, promote: promote,
        quit: quit, resign: resign, toggleMenu: toggleMenu, _gameData: null
      };
    })();

    // ════════════════════════════════════════
    // MORPION UI (Five in a Row)
    // ════════════════════════════════════════
    var MorpionUI = (function() {
      var sendActionFn = null;
      var menuOpen = false;
      var timerInterval = null;

      function startTimer(state) {
        if (timerInterval) clearInterval(timerInterval);
        var startRemaining = state.turnRemainingMs || 0;
        var total = state.turnTimeMs || 30000;
        var startTs = Date.now();
        timerInterval = setInterval(function() {
          var elapsed = Date.now() - startTs;
          var rem = Math.max(0, startRemaining - elapsed);
          var pct = (rem / total) * 100;
          var fill = document.querySelector('.morpion-timer-fill');
          if (fill) {
            fill.style.width = pct + '%';
            fill.className = 'morpion-timer-fill ' + (pct > 50 ? 'green' : pct > 25 ? 'yellow' : 'red');
          }
          if (rem <= 0) clearInterval(timerInterval);
        }, 500);
      }

      function render(state, sendAction, gameData) {
        sendActionFn = sendAction;
        var area = document.getElementById('game-area');
        var controls = document.getElementById('game-controls');
        var board = state.board;
        var size = state.size || 15;
        var isMyTurn = state.isMyTurn;
        var oppName = (gameData && gameData.players) ? gameData.players[1 - state.playerIndex].username : 'Opponent';
        var myName = (gameData && gameData.players) ? gameData.players[state.playerIndex].username : 'You';
        var mySymbol = state.symbol || 'X';
        var oppSymbol = mySymbol === 'X' ? 'O' : 'X';
        var winCells = state.winningCells || [];

        var h = '<div class="morpion-screen">';

        h += '<div class="morpion-topbar">';
        h += '<button class="back-btn" onclick="MorpionUI.quit()">&#8592;</button>';
        h += '<div class="morpion-player-info">';
        h += '<div class="name">' + oppName + '</div>';
        h += '<div class="symbol ' + (oppSymbol === 'X' ? 'x-color' : 'o-color') + '">' + oppSymbol + '</div>';
        h += '</div>';
        h += '<div class="morpion-menu-wrap"><button class="morpion-menu-btn" onclick="MorpionUI.toggleMenu(event)">&#8942;</button>';
        h += '<div class="domino-dropdown' + (menuOpen ? ' open' : '') + '">';
        h += '<button class="domino-dropdown-item danger" onclick="MorpionUI.resign(event)">Resign</button>';
        h += '</div></div></div>';

        var remaining = state.turnRemainingMs || 0;
        var total = state.turnTimeMs || 30000;
        var pct = (remaining / total) * 100;
        var timerCls = pct > 50 ? 'green' : pct > 25 ? 'yellow' : 'red';
        h += '<div class="morpion-timer"><div class="morpion-timer-fill ' + timerCls + '" style="width:' + pct + '%;"></div></div>';

        h += '<div class="morpion-board-wrap">';
        h += '<div class="morpion-board" style="grid-template-columns:repeat(' + size + ',1fr);">';

        for (var i = 0; i < size * size; i++) {
          var val = board[i];
          var isLast = state.lastMove === i;
          var isWin = winCells.indexOf(i) >= 0;
          var cls = 'morpion-cell';
          if (val !== null) cls += ' taken';
          if (isLast && !isWin) cls += ' last-move';
          if (isWin) cls += ' win-cell';

          var onclick = '';
          if (val === null && isMyTurn && !state.gameOver) {
            onclick = ' onclick="MorpionUI.placeAt(' + i + ')"';
          }

          var content = '';
          if (val === state.playerIndex) {
            content = '<span class="' + (mySymbol === 'X' ? 'x-mark' : 'o-mark') + '">' + mySymbol + '</span>';
          } else if (val !== null) {
            content = '<span class="' + (oppSymbol === 'X' ? 'x-mark' : 'o-mark') + '">' + oppSymbol + '</span>';
          }

          h += '<div class="' + cls + '"' + onclick + '>' + content + '</div>';
        }

        h += '</div></div>';

        h += '<div style="text-align:center;padding:0.5rem;">';
        h += '<div class="morpion-player-info">';
        h += '<div class="name">' + myName + '</div>';
        h += '<div class="symbol ' + (mySymbol === 'X' ? 'x-color' : 'o-color') + '">' + mySymbol + '</div>';
        h += '</div>';
        var pillCls = isMyTurn ? 'active' : 'waiting';
        var pillTxt = isMyTurn ? 'Your Turn' : "Opponent's Turn";
        h += '<div class="morpion-turn-pill ' + pillCls + '">' + pillTxt + '</div>';
        h += '</div></div>';

        area.innerHTML = h;
        controls.innerHTML = ''; controls.style.display = 'none';
        if (!state.gameOver) startTimer(state);
      }

      function placeAt(cell) { GameSounds.place(); if (sendActionFn) sendActionFn({ type: 'place', cell: cell }); }
      function quit() { if (confirm('Leave? You forfeit.')) window.location.reload(); }
      function resign(e) {
        if (e) { e.stopPropagation(); e.preventDefault(); }
        menuOpen = false;
        if (confirm('Resign this game?')) { GameSounds.resign(); if (sendActionFn) sendActionFn({ type: 'resign' }); }
      }
      function toggleMenu(e) { if (e) e.stopPropagation(); menuOpen = !menuOpen; GameSounds.click(); }

      document.addEventListener('click', function() { menuOpen = false; });

      return { render: render, placeAt: placeAt, quit: quit, resign: resign, toggleMenu: toggleMenu };
    })();

    // ════════════════════════════════════════
    // MAIN APP
    // ════════════════════════════════════════
    var App = (function() {
      var socket = null;
      var currentGame = null;
      var myPlayerIndex = null;
      var gameState = null;
      var currentGameData = null;
      var currentBalance = 0;
      var escrowAddress = null;
      var solConnection = null;
      var isTestMode = false;

      function showScreen(name) {
        var all = ['connect','lobby','waiting','game'];
        for (var i = 0; i < all.length; i++) document.getElementById('screen-' + all[i]).classList.remove('active');
        document.getElementById('screen-' + name).classList.add('active');
      }

      function updateBalanceUI(bal) {
        currentBalance = bal;
        document.getElementById('balance-amount').textContent = bal.toFixed(3);
        document.getElementById('topbar-balance').textContent = bal.toFixed(3) + ' SOL';
      }

      async function refreshBalance() {
        var walletAddr = PhantomWallet.getPublicKey();
        if (!walletAddr) return;

        var rpcUrl = PhantomWallet.getRpcUrl();
        console.log('Fetching balance from:', rpcUrl, 'for:', walletAddr);

        try {
          var body = JSON.stringify({
            jsonrpc: '2.0', id: 1,
            method: 'getBalance',
            params: [walletAddr]
          });
          var resp = await fetch(rpcUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: body
          });
          var json = await resp.json();
          if (json.error) throw new Error(json.error.message || 'RPC error');
          var lamports = json.result.value;
          var sol = lamports / 1000000000;
          updateBalanceUI(sol);
        } catch (e) {
          console.error('Balance fetch error:', e);
          showToast('Balance fetch failed — try Refresh', 'error');
        }
      }

      function init() {
        setupConnectScreen();
        setupLobbyScreen();
        setupWaitingScreen();
        setupGameOverlay();
      }

      function connectToServer() {
        var walletAddress = PhantomWallet.getPublicKey();
        try { socket = io({ reconnectionAttempts: 5, timeout: 10000 }); } catch(e) { showToast('Cannot connect to server', 'error'); return; }

        socket.on('connect', function() {
          socket.emit('register', { walletAddress: walletAddress, displayName: PhantomWallet.shortenAddress(walletAddress) });
        });

        socket.on('connect_error', function() { showToast('Server connection failed — retrying...', 'error'); });

        socket.on('registered', function(data) {
          escrowAddress = data.escrowAddress;
          isTestMode = !!data.testMode;
          document.getElementById('connected-wallet-addr').textContent = data.walletAddress;
          document.getElementById('wallet-display').textContent = PhantomWallet.shortenAddress(data.walletAddress);
          showScreen('lobby');
          refreshBalance();
        });

        socket.on('balance_update', function(data) {
          if (data.refreshWallet) refreshBalance();
          if (data.msg) showToast(data.msg, 'info');
        });

        socket.on('waiting', function(data) {
          document.getElementById('waiting-info').textContent = data.gameType.toUpperCase() + ' — ' + data.betAmount + ' SOL bet';
          showScreen('waiting');
        });

        socket.on('lobby_update', updateLobby);
        socket.on('game_start', onGameStart);
        socket.on('game_state', onGameState);
        socket.on('game_over', onGameOver);
        socket.on('search_cancelled', function() { showScreen('lobby'); });
        socket.on('error_msg', function(d) { showToast(d.msg, 'error'); });
        socket.on('disconnect', function() { showToast('Disconnected from server', 'error'); });
      }

      function setupConnectScreen() {
        var phantomBtn = document.getElementById('btn-connect-phantom');
        var errEl = document.getElementById('connect-error');

        phantomBtn.addEventListener('click', async function() {
          phantomBtn.disabled = true;
          phantomBtn.textContent = 'Connecting...';
          errEl.style.display = 'none';
          try {
            await PhantomWallet.connect();
            connectToServer();
          } catch (err) {
            errEl.textContent = err.message || 'Failed to connect wallet';
            errEl.style.display = 'block';
            phantomBtn.disabled = false;
            phantomBtn.innerHTML = '<img src="https://phantom.app/img/phantom-icon-purple.png" alt="" onerror="this.style.display=\'none\'" /> Connect Phantom Wallet';
          }
        });
      }

      function setupLobbyScreen() {
        // Network selector
        document.getElementById('network-select').addEventListener('change', function() {
          var net = this.value;
          PhantomWallet.setNetwork(net);
          var indicator = document.getElementById('network-indicator');
          if (net === 'mainnet-beta') { indicator.textContent = 'Mainnet'; indicator.style.background = 'var(--green)'; }
          else if (net === 'devnet') { indicator.textContent = 'Devnet'; indicator.style.background = 'var(--gold)'; }
          else { indicator.textContent = 'Testnet'; indicator.style.background = 'var(--accent)'; }
          solConnection = null;
          refreshBalance();
        });

        // Refresh balance
        document.getElementById('btn-refresh-balance').addEventListener('click', function() {
          refreshBalance();
          showToast('Refreshing balance...', 'info');
        });

        // Copy wallet address
        document.getElementById('connected-wallet-addr').addEventListener('click', function() {
          if (navigator.clipboard) navigator.clipboard.writeText(this.textContent).then(function() { showToast('Address copied!', 'info'); });
        });

        // Game cards — bet by signing a Phantom transfer to escrow
        var cards = document.querySelectorAll('.game-card');
        for (var ci = 0; ci < cards.length; ci++) {
          (function(card) {
            var gridBtns = card.querySelectorAll('.grid-btn');
            for (var gi = 0; gi < gridBtns.length; gi++) {
              gridBtns[gi].addEventListener('click', function() {
                for (var x = 0; x < gridBtns.length; x++) gridBtns[x].classList.remove('active');
                this.classList.add('active');
              });
            }
            card.querySelector('.btn-play').addEventListener('click', async function() {
              var gameType = card.dataset.game;
              var betInput = card.querySelector('.bet-amount-input');
              var betAmount = parseFloat(betInput.value);
              if (!betAmount || betAmount <= 0) { showToast('Enter a bet amount', 'error'); betInput.focus(); return; }
              if (!escrowAddress) { showToast('Server not ready, try again', 'error'); return; }

              var btn = this;
              btn.disabled = true;

              var payload = { gameType: gameType, betAmount: betAmount };
              var activeGrid = card.querySelector('.grid-btn.active');
              if (activeGrid) payload.gridSize = parseInt(activeGrid.dataset.grid);

              if (isTestMode) {
                payload.txSignature = 'test_' + Date.now();
                socket.emit('find_match', payload);
                btn.disabled = false;
                btn.textContent = 'Find Match';
                return;
              }

              if (betAmount > currentBalance) { showToast('Not enough SOL in your wallet!', 'error'); btn.disabled = false; return; }

              btn.textContent = 'Confirm in Phantom...';

              try {
                var provider = PhantomWallet.getProvider();
                var web3 = window.solanaWeb3;
                solConnection = new web3.Connection(PhantomWallet.getRpcUrl(), 'confirmed');

                var fromPubkey = provider.publicKey;
                var toPubkey = new web3.PublicKey(escrowAddress);
                var lamports = Math.floor(betAmount * web3.LAMPORTS_PER_SOL);

                var transaction = new web3.Transaction().add(
                  web3.SystemProgram.transfer({
                    fromPubkey: fromPubkey,
                    toPubkey: toPubkey,
                    lamports: lamports,
                  })
                );
                transaction.feePayer = fromPubkey;
                var bh = await solConnection.getLatestBlockhash('confirmed');
                transaction.recentBlockhash = bh.blockhash;

                var signed = await provider.signTransaction(transaction);
                btn.textContent = 'Sending bet...';

                var signature = await solConnection.sendRawTransaction(signed.serialize());
                btn.textContent = 'Confirming...';

                await solConnection.confirmTransaction(signature, 'confirmed');

                payload.txSignature = signature;
                socket.emit('find_match', payload);
                btn.disabled = false;
                btn.textContent = 'Find Match';
                refreshBalance();
              } catch (err) {
                showToast(err.message || 'Transaction cancelled', 'error');
                btn.disabled = false;
                btn.textContent = 'Find Match';
              }
            });
          })(cards[ci]);
        }
      }

      var pendingFilter = 'all';
      var lastLobbyData = null;

      var GAME_ICONS = { domino: '\u{1F031}', tictactoe: '\u2715\u25CB', mancala: '\u{1F332}', checkers: '\u265F', chess: '\u2654', morpion: '\u271A' };
      var GAME_NAMES = { domino: 'Domino', tictactoe: 'Tic Tac Toe', mancala: 'Mancala', checkers: 'Checkers', chess: 'Chess', morpion: 'Morpion' };

      function updateLobby(data) {
        lastLobbyData = data;
        document.getElementById('online-count').textContent = data.onlineCount + ' online';
        var connOnline = document.getElementById('connect-online');
        if (connOnline) connOnline.textContent = data.onlineCount;

        renderPendingBets(data.waiting);

        var activeList = document.getElementById('active-list');
        activeList.innerHTML = data.activeGames.length === 0
          ? '<li class="empty-msg">No active games</li>'
          : data.activeGames.map(function(g) { return '<li><span>' + g.players.join(' vs ') + '</span><span>' + (GAME_NAMES[g.gameType] || g.gameType) + ' — ' + g.betAmount + ' SOL</span></li>'; }).join('');
      }

      function renderPendingBets(bets) {
        var container = document.getElementById('pending-bets-list');
        var countEl = document.getElementById('pending-count');

        var filtered = pendingFilter === 'all' ? bets : bets.filter(function(b) { return b.gameType === pendingFilter; });

        countEl.textContent = bets.length;

        if (filtered.length === 0) {
          container.innerHTML = '<div class="pending-empty">' +
            (bets.length === 0 ? 'No open challenges yet — be the first to create one!' : 'No challenges for this game — try another filter') +
            '</div>';
          return;
        }

        var myWallet = document.getElementById('connected-wallet-addr').textContent;
        var myShort = myWallet.length > 8 ? myWallet.slice(0, 4) + '…' + myWallet.slice(-4) : '';

        var html = '';
        for (var i = 0; i < filtered.length; i++) {
          var b = filtered[i];
          var isOwn = b.wallet === myShort;
          var icon = GAME_ICONS[b.gameType] || '🎮';
          var name = GAME_NAMES[b.gameType] || b.gameType;
          var gridLabel = b.gridSize ? ' (' + b.gridSize + '×' + b.gridSize + ')' : '';

          html += '<div class="pending-bet-card' + (isOwn ? ' own-bet' : '') + '">';
          html += '<div class="pending-bet-icon">' + icon + '</div>';
          html += '<div class="pending-bet-info">';
          html += '<div class="pending-bet-game">' + name + gridLabel + '</div>';
          html += '<div class="pending-bet-player">' + b.username + ' <span class="wallet-tag">' + b.wallet + '</span></div>';
          html += '</div>';
          html += '<div class="pending-bet-amount">' + b.betAmount + ' <small>SOL</small></div>';

          if (isOwn) {
            html += '<button class="pending-bet-accept own-label" disabled>Your Bet</button>';
          } else {
            html += '<button class="pending-bet-accept" data-bet-id="' + b.id + '" data-bet-amount="' + b.betAmount + '">Accept</button>';
          }
          html += '</div>';
        }
        container.innerHTML = html;
      }

      function setupWaitingScreen() {
        document.getElementById('btn-cancel-search').addEventListener('click', function() { socket.emit('cancel_search'); });

        var filterBtns = document.querySelectorAll('.pending-filter-btn');
        for (var fi = 0; fi < filterBtns.length; fi++) {
          filterBtns[fi].addEventListener('click', function() {
            for (var x = 0; x < filterBtns.length; x++) filterBtns[x].classList.remove('active');
            this.classList.add('active');
            pendingFilter = this.dataset.filter;
            if (lastLobbyData) renderPendingBets(lastLobbyData.waiting);
          });
        }

        document.getElementById('pending-bets-list').addEventListener('click', function(e) {
          var btn = e.target.closest('.pending-bet-accept');
          if (!btn || btn.disabled || btn.classList.contains('own-label')) return;
          var betId = btn.getAttribute('data-bet-id');
          var betAmount = parseFloat(btn.getAttribute('data-bet-amount'));
          if (!betId) return;
          acceptBet(betId, betAmount, btn);
        });
      }

      async function acceptBet(betId, betAmount, btn) {
        if (!socket) { showToast('Not connected to server', 'error'); return; }
        if (!escrowAddress) { showToast('Server not ready, try again', 'error'); return; }

        btn.disabled = true;
        btn.textContent = 'Joining...';
        btn.style.background = '#ffc107';

        var resetBtn = function(errMsg) {
          btn.disabled = false;
          btn.textContent = 'Accept';
          btn.style.background = '';
          if (errMsg) {
            showToast(errMsg, 'error');
            btn.textContent = 'Retry';
            btn.style.background = '#ff3d57';
            setTimeout(function() { btn.textContent = 'Accept'; btn.style.background = ''; }, 4000);
          }
        };

        var onServerError = function(d) { resetBtn(d.msg); };
        socket.once('error_msg', onServerError);
        socket.once('game_start', function() { socket.off('error_msg', onServerError); });

        if (isTestMode) {
          socket.emit('accept_bet', { betId: betId, txSignature: 'test_accept_' + Date.now() });
          return;
        }

        try {
          var provider = PhantomWallet.getProvider();
          if (!provider || !provider.publicKey) throw new Error('Wallet not connected — reconnect Phantom');

          btn.textContent = 'Confirm in Phantom...';
          var web3 = window.solanaWeb3;
          if (!web3) throw new Error('Solana library not loaded — refresh page');

          var rpcUrl = PhantomWallet.getRpcUrl();
          solConnection = new web3.Connection(rpcUrl, 'confirmed');

          var fromPubkey = provider.publicKey;
          var toPubkey = new web3.PublicKey(escrowAddress);
          var lamports = Math.floor(betAmount * web3.LAMPORTS_PER_SOL);

          var transaction = new web3.Transaction().add(
            web3.SystemProgram.transfer({ fromPubkey: fromPubkey, toPubkey: toPubkey, lamports: lamports })
          );
          transaction.feePayer = fromPubkey;

          btn.textContent = 'Getting blockhash...';
          var bh = await solConnection.getLatestBlockhash('confirmed');
          transaction.recentBlockhash = bh.blockhash;

          btn.textContent = 'Sign in Phantom...';
          var signed = await provider.signTransaction(transaction);

          btn.textContent = 'Sending tx...';
          var signature = await solConnection.sendRawTransaction(signed.serialize());

          btn.textContent = 'Confirming tx...';
          await solConnection.confirmTransaction(signature, 'confirmed');

          btn.textContent = 'Matching...';
          btn.style.background = 'var(--green)';
          socket.emit('accept_bet', { betId: betId, txSignature: signature });
          refreshBalance();
        } catch (err) {
          socket.off('error_msg', onServerError);
          var msg = err.message || 'Transaction failed';
          if (msg.indexOf('User rejected') >= 0 || msg.indexOf('cancelled') >= 0) msg = 'You cancelled the transaction';
          resetBtn(msg);
        }
      }

      function onGameStart(data) {
        currentGame = data.gameType;
        myPlayerIndex = data.playerIndex;
        currentGameData = data;

        var topbar = document.querySelector('.game-topbar');
        var immersive = ['domino', 'mancala', 'checkers', 'chess', 'morpion'];
        if (immersive.indexOf(data.gameType) >= 0) {
          topbar.style.display = 'none';
          if (data.gameType === 'checkers') CheckersUI._gameData = data;
          if (data.gameType === 'chess') ChessUI._gameData = data;
        } else {
          topbar.style.display = '';
          document.getElementById('game-type-label').textContent = data.gameType.toUpperCase();
          document.getElementById('game-bet-label').textContent = data.betAmount + ' SOL';
          document.getElementById('player1-label').textContent = data.players[0].username;
          document.getElementById('player2-label').textContent = data.players[1].username;
          document.getElementById('player1-label').style.color = data.playerIndex === 0 ? '#00d4aa' : '';
          document.getElementById('player2-label').style.color = data.playerIndex === 1 ? '#00d4aa' : '';
        }
        showScreen('game');
      }

      function onGameState(state) {
        var prevTurn = gameState ? gameState.isMyTurn : null;
        gameState = state;
        if (prevTurn !== null && state.isMyTurn && !prevTurn) GameSounds.turn();
        if (state.inCheck) GameSounds.check();

        if (state.gameType === 'domino') {
          DominoUI.render(state, sendAction, currentGameData);
        } else if (state.gameType === 'mancala') {
          MancalaUI.render(state, sendAction, currentGameData);
        } else if (state.gameType === 'checkers') {
          CheckersUI.render(state, sendAction, CheckersUI._gameData || currentGameData);
        } else if (state.gameType === 'chess') {
          ChessUI.render(state, sendAction, ChessUI._gameData || currentGameData);
        } else if (state.gameType === 'morpion') {
          MorpionUI.render(state, sendAction, currentGameData);
        } else {
          var turnEl = document.getElementById('turn-indicator');
          turnEl.textContent = state.isMyTurn ? 'YOUR TURN' : "OPPONENT'S TURN";
          turnEl.className = 'turn-indicator ' + (state.isMyTurn ? 'my-turn' : 'their-turn');
          if (state.gameType === 'tictactoe') TicTacToeUI.render(state, sendAction);
        }
      }

      function sendAction(action) { if (socket) socket.emit('game_action', action); }

      function onGameOver(data) {
        var overlay = document.getElementById('overlay-gameover');
        var title = document.getElementById('gameover-title');
        var detail = document.getElementById('gameover-detail');
        var payout = document.getElementById('gameover-payout');
        if (data.isDraw) {
          title.textContent = 'DRAW!'; title.style.color = '#f59e0b';
          detail.textContent = 'Nobody wins — bets returned.'; payout.textContent = '';
          GameSounds.turn();
        } else {
          var iWon = data.winnerWallet === PhantomWallet.getPublicKey();
          title.textContent = iWon ? 'YOU WIN!' : 'YOU LOSE';
          title.style.color = iWon ? '#00c853' : '#ff3d57';
          detail.textContent = data.reason ? data.winner + ' wins — ' + data.reason : data.winner + ' wins!';
          payout.textContent = iWon ? '+' + data.payout.toFixed(3) + ' SOL' : '';
          if (iWon) GameSounds.win(); else GameSounds.lose();
        }
        overlay.classList.remove('hidden');
      }

      function setupGameOverlay() {
        document.getElementById('btn-back-lobby').addEventListener('click', function() {
          document.getElementById('overlay-gameover').classList.add('hidden');
          currentGame = null; gameState = null; currentGameData = null;
          document.querySelector('.game-topbar').style.display = '';
          document.getElementById('game-controls').style.display = '';
          showScreen('lobby');
          if (socket) socket.emit('get_lobby');
          refreshBalance();
        });
      }

      function showToast(msg, type) {
        type = type || 'info';
        var t = document.createElement('div');
        var bg = type === 'error' ? '#ff3d57' : '#00d4aa';
        t.style.cssText = 'position:fixed;bottom:1.5rem;right:1.5rem;z-index:9999;background:' + bg + ';color:#fff;padding:0.7rem 1.2rem;border-radius:8px;font-size:0.85rem;font-weight:600;box-shadow:0 4px 24px rgba(0,0,0,0.4);backdrop-filter:blur(8px);max-width:320px;animation:toastIn 0.3s ease;';
        t.textContent = msg; document.body.appendChild(t);
        setTimeout(function() { t.style.opacity = '0'; t.style.transform = 'translateY(10px)'; t.style.transition = 'all 0.3s'; }, 3000);
        setTimeout(function() { t.remove(); }, 3400);
      }

      document.addEventListener('DOMContentLoaded', init);
      return { showScreen: showScreen, sendAction: sendAction, acceptBet: acceptBet };
    })();

  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/sw.js').catch(function() {});
      });
    }
  </script>
</body>
</html>
