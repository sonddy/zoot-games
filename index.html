<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ZG — Zoot Games | Play & Earn Crypto</title>
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#8b5cf6" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="ZG" />
  <link rel="apple-touch-icon" href="/icons/icon-192.svg" />
  <meta name="description" content="Play Domino, Tic Tac Toe & more — bet Solana crypto and win!" />
  <link rel="icon" type="image/svg+xml" href="/icons/icon-192.svg" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0a0e17;
      --bg2: #111827;
      --surface: #1f2937;
      --surface2: #374151;
      --accent: #8b5cf6;
      --accent2: #a78bfa;
      --green: #10b981;
      --red: #ef4444;
      --gold: #f59e0b;
      --text: #f3f4f6;
      --text2: #9ca3af;
      --radius: 12px;
      --radius-sm: 8px;
      --felt: #1a5c3a;
      --felt2: #14472d;
    }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .screen { display: none; min-height: 100vh; }
    .screen.active { display: flex; }

    #screen-connect {
      align-items: center;
      justify-content: center;
      background: radial-gradient(ellipse at 50% 30%, #1a1040 0%, var(--bg) 70%);
    }
    .connect-container { text-align: center; max-width: 480px; padding: 2rem; }
    .logo { margin-bottom: 0.5rem; }
    .logo-mark {
      display: inline-flex; align-items: center; justify-content: center;
      width: 80px; height: 80px; border-radius: 20px;
      background: linear-gradient(135deg, var(--accent), #6d28d9);
      font-size: 2.2rem; font-weight: 800; color: #fff; letter-spacing: -2px;
      margin-bottom: 1rem; box-shadow: 0 8px 32px rgba(139,92,246,0.35);
    }
    .logo h1 { font-size: 2.6rem; font-weight: 800; letter-spacing: -1px; }
    .accent { color: var(--accent); }
    .logo-subtitle { font-size: 0.95rem; color: var(--text2); font-weight: 500; letter-spacing: 3px; text-transform: uppercase; margin-top: 0.2rem; }
    .tagline { font-size: 1.25rem; color: var(--text2); margin-bottom: 2.5rem; margin-top: 0.5rem; }
    .connect-form { display: flex; flex-direction: column; gap: 1rem; }

    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
      border: none; border-radius: var(--radius); font-family: inherit; font-weight: 600;
      cursor: pointer; transition: all 0.2s; padding: 0.7rem 1.4rem; font-size: 0.95rem;
    }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:hover { background: var(--accent2); transform: translateY(-1px); }
    .btn-danger { background: var(--red); color: #fff; }
    .btn-danger:hover { opacity: 0.85; }
    .btn-lg { padding: 1rem 1.8rem; font-size: 1.1rem; }
    .small-text { color: var(--text2); font-size: 0.8rem; margin-top: 0.5rem; }

    .btn-phantom {
      background: linear-gradient(135deg, #ab9ff2, #6e56cf);
      color: #fff; border: none; border-radius: var(--radius);
      padding: 1rem 1.8rem; font-size: 1.1rem; font-weight: 700; font-family: inherit;
      cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.7rem;
      transition: all 0.2s; width: 100%;
      box-shadow: 0 4px 20px rgba(110,86,207,0.4);
    }
    .btn-phantom:hover { transform: translateY(-2px); box-shadow: 0 6px 28px rgba(110,86,207,0.5); }
    .btn-phantom:disabled { opacity: 0.6; cursor: default; transform: none; }
    .btn-phantom img { width: 24px; height: 24px; }

    .topbar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0.8rem 1.5rem; background: var(--bg2);
      border-bottom: 1px solid var(--surface2); position: sticky; top: 0; z-index: 100;
    }
    .topbar-left, .topbar-center, .topbar-right { display: flex; align-items: center; gap: 0.7rem; }
    .logo-sm { font-weight: 800; font-size: 1.1rem; display: flex; align-items: center; gap: 0.4rem; }
    .logo-sm-mark {
      display: inline-flex; align-items: center; justify-content: center;
      width: 30px; height: 30px; border-radius: 7px;
      background: linear-gradient(135deg, var(--accent), #6d28d9);
      font-size: 0.75rem; font-weight: 800; color: #fff; letter-spacing: -1px;
    }
    .badge { background: var(--surface); padding: 0.3rem 0.7rem; border-radius: 999px; font-size: 0.8rem; color: var(--text2); }
    .wallet-badge { background: var(--surface); padding: 0.3rem 0.7rem; border-radius: 999px; font-size: 0.75rem; color: var(--accent2); font-family: monospace; }

    #screen-lobby { flex-direction: column; }
    .lobby-main { max-width: 960px; margin: 0 auto; padding: 2rem 1.5rem; width: 100%; }
    .lobby-main > h2 { font-size: 1.5rem; margin-bottom: 1.5rem; font-weight: 700; }
    .game-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 1.5rem; margin-bottom: 2.5rem; }
    .game-card {
      background: var(--bg2); border: 1px solid var(--surface2); border-radius: var(--radius);
      padding: 1.8rem; transition: border-color 0.2s, transform 0.2s;
    }
    .game-card:hover { border-color: var(--accent); transform: translateY(-2px); }
    .game-card-icon { font-size: 2.8rem; margin-bottom: 0.5rem; }
    .game-card h3 { font-size: 1.3rem; margin-bottom: 0.3rem; }
    .game-card p { color: var(--text2); font-size: 0.9rem; margin-bottom: 1.2rem; line-height: 1.4; }
    .grid-options { display: flex; gap: 0.4rem; flex-wrap: wrap; }
    .grid-btn {
      background: var(--surface); border: 2px solid var(--surface2); color: var(--text);
      border-radius: var(--radius-sm); padding: 0.4rem 0.9rem; font-family: inherit;
      font-weight: 600; font-size: 0.85rem; cursor: pointer; transition: all 0.15s;
    }
    .grid-btn:hover { border-color: var(--accent); }
    .grid-btn.active { border-color: var(--accent); background: rgba(139,92,246,0.15); color: var(--accent2); }
    .grid-select { margin-bottom: 1rem; }
    .grid-select label { font-size: 0.85rem; color: var(--text2); display: block; margin-bottom: 0.5rem; }
    .btn-play { width: 100%; }
    .bet-input-group { display: flex; gap: 0.5rem; align-items: center; margin-bottom: 1rem; }
    .bet-input-group label { font-size: 0.85rem; color: var(--text2); }
    .bet-input-group input[type="number"] {
      background: var(--surface); border: 2px solid var(--surface2); border-radius: var(--radius-sm);
      padding: 0.5rem 0.7rem; color: var(--gold); font-family: inherit; font-size: 1rem;
      font-weight: 700; outline: none; width: 110px; transition: border-color 0.2s;
    }
    .bet-input-group input[type="number"]:focus { border-color: var(--accent); }
    .bet-input-group .sol-label { font-size: 0.9rem; color: var(--text2); font-weight: 600; }

    .live-section { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
    .live-col h4 { font-size: 0.95rem; margin-bottom: 0.8rem; color: var(--text2); }
    .activity-list { list-style: none; display: flex; flex-direction: column; gap: 0.4rem; max-height: 200px; overflow-y: auto; }
    .activity-list li { background: var(--surface); padding: 0.5rem 0.8rem; border-radius: var(--radius-sm); font-size: 0.85rem; display: flex; justify-content: space-between; }
    .activity-list .empty-msg { color: var(--text2); font-style: italic; }

    #screen-waiting { align-items: center; justify-content: center; flex-direction: column; background: var(--bg); }
    .waiting-container { text-align: center; }
    .waiting-container h2 { margin: 1.5rem 0 0.5rem; }
    .waiting-container p { color: var(--text2); margin-bottom: 1.5rem; }
    .spinner { width: 50px; height: 50px; border: 4px solid var(--surface2); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto; }
    @keyframes spin { to { transform: rotate(360deg); } }

    #screen-game { flex-direction: column; }
    .game-topbar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0.7rem 1.5rem; background: var(--bg2); border-bottom: 1px solid var(--surface2);
      flex-wrap: wrap; gap: 0.5rem;
    }
    .game-info { display: flex; gap: 0.5rem; }
    .badge-game { background: var(--accent); color: #fff; }
    .badge-bet { background: var(--gold); color: #000; font-weight: 700; }
    .game-players { display: flex; align-items: center; gap: 0.5rem; }
    .player-label { font-weight: 600; font-size: 0.9rem; }
    .vs { color: var(--text2); font-size: 0.8rem; }
    .turn-indicator { font-size: 0.9rem; font-weight: 600; padding: 0.3rem 0.8rem; border-radius: 999px; }
    .turn-indicator.my-turn { background: var(--green); color: #fff; }
    .turn-indicator.their-turn { background: var(--surface); color: var(--text2); }
    .game-area { flex: 1; display: block; padding: 0; overflow: hidden; position: relative; }
    .game-controls { background: var(--bg2); border-top: 1px solid var(--surface2); padding: 1rem 1.5rem; min-height: 0; }

    /* ═══ DOMINO — Plato / Domino King exact replica ═══ */
    .domino-screen {
      display: flex; flex-direction: column; position: fixed; inset: 0;
      background: linear-gradient(180deg, #1a3a8a 0%, #2563eb 10%, #3b82f6 50%, #2563eb 90%, #1a3a8a 100%);
      z-index: 10;
    }
    .domino-opp-bar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0.2rem 0.7rem;
      background: linear-gradient(180deg, #0c1d4d 0%, #152d6e 100%);
    }
    .domino-opp-bar .back-btn {
      width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.12);
      border: none; color: #fff; font-size: 1.1rem; cursor: pointer; display: flex;
      align-items: center; justify-content: center;
    }
    .domino-opp-center { display: flex; flex-direction: column; align-items: center; }
    .domino-opp-top-row { display: flex; align-items: center; gap: 0.4rem; }
    .domino-avatar {
      width: 36px; height: 36px; border-radius: 50%; background: #374151;
      display: flex; align-items: center; justify-content: center;
      font-size: 1rem; font-weight: 800; color: #fff;
      border: 2.5px solid #60a5fa; box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .domino-avatar.my { border-color: #22c55e; }
    .domino-score-big { font-size: 1.2rem; font-weight: 800; color: #fff; letter-spacing: -0.5px; }
    .domino-name-row { display: flex; align-items: center; gap: 0.3rem; margin-top: 0.1rem; }
    .domino-online-dot { width: 7px; height: 7px; border-radius: 50%; background: #22c55e; }
    .domino-username { font-size: 0.8rem; font-weight: 600; color: #93c5fd; }
    .domino-menu-btn {
      width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.12);
      border: none; color: #fff; font-size: 1.2rem; cursor: pointer; display: flex;
      align-items: center; justify-content: center; position: relative;
    }
    .domino-dropdown {
      position: absolute; top: 44px; right: 0; background: #1e3a8a; border: 1.5px solid #3b82f6;
      border-radius: 10px; min-width: 140px; box-shadow: 0 8px 24px rgba(0,0,0,0.5); z-index: 100;
      overflow: hidden; display: none;
    }
    .domino-dropdown.open { display: block; }
    .domino-dropdown-item {
      padding: 0.7rem 1rem; color: #fff; font-size: 0.9rem; font-weight: 600; cursor: pointer;
      border: none; background: none; width: 100%; text-align: left; font-family: inherit;
    }
    .domino-dropdown-item:hover { background: rgba(255,255,255,0.12); }
    .domino-dropdown-item.danger { color: #f87171; }

    .domino-opp-tiles {
      display: flex; gap: 2px; justify-content: center; padding: 0.15rem 0.5rem;
      background: linear-gradient(180deg, #152d6e 0%, #1e3a8a 100%);
    }
    .domino-tile-back {
      width: 20px; height: 34px; border-radius: 4px;
      background: linear-gradient(180deg, #5b9cf6 0%, #3b7de8 50%, #2a5fc4 100%);
      border: 1.5px solid #7db8ff; box-shadow: 1px 2px 3px rgba(0,0,0,0.25);
    }

    .domino-timer-bar { height: 5px; background: #1e3a8a; position: relative; }
    .domino-timer-fill {
      height: 100%; border-radius: 0 2px 2px 0;
      transition: width 1s linear;
    }
    .domino-timer-fill.green { background: linear-gradient(90deg, #22c55e, #4ade80); }
    .domino-timer-fill.yellow { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
    .domino-timer-fill.red { background: linear-gradient(90deg, #ef4444, #f87171); }

    .domino-board-area {
      flex: 1; position: relative; overflow: hidden;
      margin: 0.3rem 0.5rem;
      min-height: 0;
      background: rgba(30,90,210,0.25);
      border-radius: 10px;
      border: 2.5px solid rgba(96,165,250,0.35);
      box-shadow: inset 0 2px 12px rgba(0,0,0,0.15);
    }
    .domino-board-inner {
      position: absolute; inset: 0; overflow-x: hidden; overflow-y: auto;
      display: flex; align-items: flex-start; justify-content: center;
      padding: 6px 0;
    }
    .domino-board-canvas { position: relative; }
    .domino-chain-empty {
      color: rgba(255,255,255,0.35); font-style: italic; font-size: 1rem;
      position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
    }
    .domino-boneyard {
      position: absolute; right: 0.5rem; bottom: 0.5rem;
      display: flex; flex-direction: column; align-items: center; gap: 0.2rem;
    }
    .domino-boneyard-stack { position: relative; width: 28px; height: 44px; }
    .domino-boneyard-card {
      position: absolute; width: 24px; height: 40px; border-radius: 4px;
      background: linear-gradient(180deg, #5b9cf6, #2a5fc4); border: 1.5px solid #7db8ff;
    }
    .domino-boneyard-count { font-size: 0.75rem; color: rgba(255,255,255,0.7); font-weight: 600; }

    .dtile {
      display: inline-flex; background: #fff; border-radius: 5px;
      box-shadow: 1px 2px 6px rgba(0,0,0,0.4); position: relative;
    }
    .dtile-h { flex-direction: row; }
    .dtile-v { flex-direction: column; }
    .dtile-half { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; }
    .dtile-div-h { width: 1px; height: 24px; background: #ccc; align-self: center; }
    .dtile-div-v { height: 1px; width: 24px; background: #ccc; align-self: center; }
    .pip-container { width: 22px; height: 22px; display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); }
    .pip { width: 5px; height: 5px; background: #111; border-radius: 50%; align-self: center; justify-self: center; }
    .dtile-board { position: absolute; }
    .dtile-hand-tile {
      display: inline-flex; border-radius: 5px; box-shadow: 1px 2px 5px rgba(0,0,0,0.35);
      background: linear-gradient(180deg, #e8e8e8 0%, #c8c8c8 100%); border: 1.5px solid #aaa;
    }
    .dtile-hand-tile .pip { background: #222; }

    @media (max-width: 480px) {
      .dtile-half { width: 20px; height: 20px; }
      .dtile-div-h { height: 17px; }
      .dtile-div-v { width: 17px; }
      .pip-container { width: 16px; height: 16px; }
      .pip { width: 3.5px; height: 3.5px; }
      .dtile { border-radius: 3px; }
      .dtile-hand-tile { border-radius: 3px; }
      .domino-tile-back { width: 16px; height: 28px; border-radius: 3px; }
      .domino-boneyard-stack { width: 22px; height: 36px; }
      .domino-boneyard-card { width: 18px; height: 32px; border-radius: 3px; }
      .domino-opp-bar { padding: 0.15rem 0.5rem; }
      .domino-avatar { width: 30px; height: 30px; font-size: 0.85rem; }
      .domino-score-big { font-size: 1rem; }
      .domino-username { font-size: 0.7rem; }
      .domino-opp-bar .back-btn, .domino-menu-btn { width: 28px; height: 28px; font-size: 1rem; }
      .domino-my-hand { padding: 0.2rem 0.3rem; gap: 2px; }
      .domino-hand-wrap.selected { transform: translateY(-6px); }
      .domino-hand-wrap:hover { transform: translateY(-4px); }
      .side-btn { padding: 0.3rem 0.7rem; font-size: 0.7rem; }
      .draw-btn { padding: 0.3rem 0.8rem; font-size: 0.75rem; }
      .domino-my-bar { padding: 0.15rem 0.5rem 0.2rem; }
      .domino-my-top-row { gap: 0.3rem; }
    }
    @media (max-width: 380px) {
      .dtile-half { width: 18px; height: 18px; }
      .dtile-div-h { height: 15px; }
      .dtile-div-v { width: 15px; }
      .pip-container { width: 14px; height: 14px; }
      .pip { width: 3px; height: 3px; }
      .domino-tile-back { width: 14px; height: 24px; }
      .domino-boneyard-stack { width: 20px; height: 32px; }
      .domino-boneyard-card { width: 16px; height: 28px; }
    }

    .domino-my-hand {
      display: flex; gap: 3px; justify-content: center; flex-wrap: nowrap;
      padding: 0.3rem 0.5rem;
      background: linear-gradient(180deg, #2563eb 0%, #1e3a8a 100%);
      border-top: 3px solid #3b82f6; overflow-x: auto;
    }
    .domino-hand-wrap {
      cursor: pointer; transition: transform 0.15s, box-shadow 0.15s;
      border: 2px solid transparent; border-radius: 6px; flex-shrink: 0;
    }
    .domino-hand-wrap:hover { transform: translateY(-6px); box-shadow: 0 6px 16px rgba(0,0,0,0.5); }
    .domino-hand-wrap.selected { border-color: #fbbf24; transform: translateY(-10px); box-shadow: 0 0 18px rgba(251,191,36,0.6); }

    .domino-my-bar {
      display: flex; flex-direction: column; align-items: center;
      padding: 0.2rem 1rem 0.3rem;
      background: linear-gradient(180deg, #1e3a8a 0%, #0c1d4d 100%);
    }
    .domino-my-top-row { display: flex; align-items: center; gap: 0.5rem; }
    .domino-turn-pill {
      display: inline-block; padding: 0.15rem 1rem; border-radius: 999px;
      font-size: 0.75rem; font-weight: 700; margin-top: 0.1rem;
    }
    .domino-turn-pill.active { background: #2563eb; color: #fff; }
    .domino-turn-pill.waiting { background: #374151; color: #6b7280; }

    .domino-actions {
      display: flex; gap: 0.5rem; align-items: center; justify-content: center; padding: 0.2rem 0;
    }
    .side-btn {
      background: rgba(255,255,255,0.15); border: 2px solid #60a5fa; color: #93c5fd;
      border-radius: 8px; padding: 0.4rem 0.9rem; font-family: inherit;
      font-weight: 700; font-size: 0.8rem; cursor: pointer; transition: all 0.15s;
    }
    .side-btn:hover { background: #3b82f6; color: #fff; }
    .draw-btn {
      background: #f59e0b; color: #000; border: none; border-radius: 8px;
      padding: 0.5rem 1.2rem; font-family: inherit; font-weight: 700; cursor: pointer; font-size: 0.85rem;
    }
    .draw-btn:hover { background: #d97706; }
    .pass-btn {
      background: #ef4444; color: #fff; border: none; border-radius: 8px;
      padding: 0.5rem 1.2rem; font-family: inherit; font-weight: 700; cursor: pointer; font-size: 0.85rem;
    }
    .pass-btn:hover { background: #dc2626; }

    .ttt-grid { display: grid; gap: 5px; }
    .ttt-cell {
      background: var(--surface); border: 2px solid var(--surface2); border-radius: var(--radius-sm);
      display: flex; align-items: center; justify-content: center;
      font-weight: 800; cursor: pointer; transition: background 0.15s, border-color 0.15s; user-select: none;
    }
    .ttt-cell:hover { border-color: var(--accent); background: var(--bg2); }
    .ttt-cell.x { color: var(--accent2); }
    .ttt-cell.o { color: var(--gold); }
    .ttt-cell.taken { cursor: default; }

    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .overlay.hidden { display: none; }
    .overlay-box { background: var(--bg2); border: 1px solid var(--surface2); border-radius: var(--radius); padding: 2.5rem; text-align: center; max-width: 400px; width: 90%; }
    .overlay-box h2 { font-size: 1.8rem; margin-bottom: 0.5rem; }
    .overlay-box p { color: var(--text2); margin-bottom: 0.5rem; }
    .payout-text { font-size: 1.3rem; font-weight: 700; color: var(--gold); margin: 1rem 0; }

    .wallet-panel {
      background: var(--bg2); border: 1px solid var(--surface2); border-radius: var(--radius);
      padding: 1.5rem; margin-bottom: 2rem;
    }
    .wallet-panel h3 { font-size: 1.1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
    .balance-display { font-size: 2rem; font-weight: 800; color: var(--gold); margin-bottom: 0.2rem; }
    .balance-sub { font-size: 0.8rem; color: var(--text2); margin-bottom: 1rem; }
    .wallet-address-box {
      background: var(--surface); border: 1px solid var(--surface2); border-radius: var(--radius-sm);
      padding: 0.6rem 0.8rem; font-family: monospace; font-size: 0.75rem; color: var(--accent2);
      word-break: break-all; margin-bottom: 0.8rem; cursor: pointer;
    }
    .wallet-address-box:hover { border-color: var(--accent); }
    .wallet-address-label { font-size: 0.75rem; color: var(--text2); margin-bottom: 0.3rem; display: block; }
    .wallet-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .wallet-actions input[type="number"] {
      background: var(--surface); border: 2px solid var(--surface2); border-radius: var(--radius-sm);
      padding: 0.5rem 0.7rem; color: var(--text); font-family: inherit; font-size: 0.9rem;
      outline: none; width: 140px; transition: border-color 0.2s;
    }
    .wallet-actions input[type="number"]:focus { border-color: var(--accent); }
    .btn-deposit { background: var(--green); color: #fff; border: none; border-radius: var(--radius-sm); padding: 0.5rem 1rem; font-weight: 700; cursor: pointer; font-family: inherit; }
    .btn-deposit:hover { opacity: 0.85; }
    .btn-withdraw { background: var(--red); color: #fff; border: none; border-radius: var(--radius-sm); padding: 0.5rem 1rem; font-weight: 700; cursor: pointer; font-family: inherit; }
    .btn-withdraw:hover { opacity: 0.85; }
    .wallet-row { display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.6rem; flex-wrap: wrap; }
    .wallet-row label { font-size: 0.85rem; color: var(--text2); min-width: 70px; }
    .status-msg { margin-top: 0.6rem; padding: 0.5rem 0.8rem; border-radius: 8px; font-size: 0.85rem; font-weight: 600; display: none; }

    @media (max-width: 700px) {
      .game-cards { grid-template-columns: 1fr; }
      .live-section { grid-template-columns: 1fr; }
      .topbar { flex-wrap: wrap; gap: 0.5rem; }
      .logo h1 { font-size: 2rem; }
      .logo-mark { width: 64px; height: 64px; font-size: 1.8rem; }
    }
  </style>
</head>
<body>

  <!-- CONNECT SCREEN -->
  <div id="screen-connect" class="screen active">
    <div class="connect-container">
      <div class="logo">
        <div class="logo-mark">ZG</div>
        <h1><span class="accent">Zoot</span> Games</h1>
        <div class="logo-subtitle">Play &bull; Bet &bull; Win</div>
      </div>
      <p class="tagline">Connect your Phantom wallet. Bet SOL. Win big.</p>

      <div class="connect-form">
        <button id="btn-connect-phantom" class="btn-phantom">
          <img src="https://phantom.app/img/phantom-icon-purple.png" alt="" onerror="this.style.display='none'" />
          Connect Phantom Wallet
        </button>
        <p class="small-text">Your Phantom wallet is used for all bets and transactions</p>
        <p id="connect-error" style="color:var(--red);font-size:0.85rem;display:none;"></p>
      </div>
    </div>
  </div>

  <!-- LOBBY SCREEN -->
  <div id="screen-lobby" class="screen">
    <header class="topbar">
      <div class="topbar-left">
        <span class="logo-sm"><span class="logo-sm-mark">ZG</span><span><span class="accent">Zoot</span> Games</span></span>
      </div>
      <div class="topbar-center"><span id="online-count" class="badge">0 online</span></div>
      <div class="topbar-right">
        <span id="topbar-balance" class="badge" style="color:var(--gold);font-weight:700;">0 SOL</span>
        <span id="wallet-display" class="wallet-badge"></span>
      </div>
    </header>
    <main class="lobby-main">
      <div class="wallet-panel">
        <h3>&#128176; Your Wallet</h3>
        <div class="balance-display"><span id="balance-amount">--</span> SOL</div>
        <div class="balance-sub">Your real Solana wallet balance &mdash; this SOL is used for bets</div>
        <div style="display:flex;align-items:center;gap:0.6rem;margin-bottom:0.8rem;">
          <span style="font-size:0.8rem;color:var(--text2);">Network:</span>
          <select id="network-select" style="background:var(--surface);border:1px solid var(--surface2);color:var(--accent2);border-radius:6px;padding:0.3rem 0.6rem;font-size:0.8rem;font-family:inherit;cursor:pointer;">
            <option value="mainnet-beta">Mainnet</option>
            <option value="devnet">Devnet</option>
            <option value="testnet">Testnet</option>
          </select>
          <span id="network-indicator" style="font-size:0.7rem;padding:0.2rem 0.5rem;border-radius:999px;background:var(--green);color:#fff;font-weight:600;">Mainnet</span>
        </div>
        <span class="wallet-address-label">Connected wallet (click to copy):</span>
        <div class="wallet-address-box" id="connected-wallet-addr" title="Click to copy">Loading...</div>
        <button id="btn-refresh-balance" class="btn" style="padding:0.4rem 1rem;font-size:0.85rem;background:var(--surface2);color:var(--text);margin-top:0.3rem;">&#x21bb; Refresh Balance</button>
      </div>

      <h2>Choose Your Game</h2>
      <div class="game-cards">
        <div class="game-card" data-game="domino">
          <div class="game-card-icon">&#127073;</div>
          <h3>Domino</h3>
          <p>Classic 1v1 &mdash; 7 tiles each, draw from the pile, block your opponent</p>
          <div class="bet-input-group">
            <label>Bet:</label>
            <input type="number" class="bet-amount-input" placeholder="0.5" min="0.001" step="0.001" value="0.5" />
            <span class="sol-label">SOL</span>
          </div>
          <button class="btn btn-primary btn-play">Find Match</button>
        </div>

        <div class="game-card" data-game="tictactoe">
          <div class="game-card-icon">&#10005;&#9675;</div>
          <h3>Tic Tac Toe</h3>
          <p>Outsmart your opponent &mdash; pick your grid size and go!</p>
          <div class="grid-select">
            <label>Grid Size:</label>
            <div class="grid-options">
              <button class="grid-btn active" data-grid="3">3&times;3</button>
              <button class="grid-btn" data-grid="5">5&times;5</button>
              <button class="grid-btn" data-grid="7">7&times;7</button>
            </div>
          </div>
          <div class="bet-input-group">
            <label>Bet:</label>
            <input type="number" class="bet-amount-input" placeholder="0.5" min="0.001" step="0.001" value="0.5" />
            <span class="sol-label">SOL</span>
          </div>
          <button class="btn btn-primary btn-play">Find Match</button>
        </div>
      </div>

      <section class="live-section">
        <div class="live-col">
          <h4>&#128269; Waiting for Opponents</h4>
          <ul id="waiting-list" class="activity-list"></ul>
        </div>
        <div class="live-col">
          <h4>&#9876;&#65039; Active Games</h4>
          <ul id="active-list" class="activity-list"></ul>
        </div>
      </section>
    </main>
  </div>

  <!-- WAITING SCREEN -->
  <div id="screen-waiting" class="screen">
    <div class="waiting-container">
      <div class="spinner"></div>
      <h2>Searching for opponent...</h2>
      <p id="waiting-info"></p>
      <button id="btn-cancel-search" class="btn btn-danger">Cancel</button>
    </div>
  </div>

  <!-- GAME SCREEN -->
  <div id="screen-game" class="screen">
    <header class="game-topbar">
      <div class="game-info">
        <span id="game-type-label" class="badge badge-game"></span>
        <span id="game-bet-label" class="badge badge-bet"></span>
      </div>
      <div class="game-players">
        <span id="player1-label" class="player-label"></span>
        <span class="vs">VS</span>
        <span id="player2-label" class="player-label"></span>
      </div>
      <div id="turn-indicator" class="turn-indicator"></div>
    </header>
    <div id="game-area" class="game-area"></div>
    <div id="game-controls" class="game-controls"></div>
  </div>

  <!-- GAME OVER OVERLAY -->
  <div id="overlay-gameover" class="overlay hidden">
    <div class="overlay-box">
      <h2 id="gameover-title"></h2>
      <p id="gameover-detail"></p>
      <p id="gameover-payout" class="payout-text"></p>
      <button id="btn-back-lobby" class="btn btn-primary">Back to Lobby</button>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
  <script>
    // ════════════════════════════════════════
    // PIP RENDERER
    // ════════════════════════════════════════
    var PipLayouts = {
      0: [], 1: [[1,1]], 2: [[0,2],[2,0]], 3: [[0,2],[1,1],[2,0]],
      4: [[0,0],[0,2],[2,0],[2,2]], 5: [[0,0],[0,2],[1,1],[2,0],[2,2]],
      6: [[0,0],[0,2],[1,0],[1,2],[2,0],[2,2]],
    };

    function renderPips(n) {
      var html = '<div class="pip-container">';
      var cells = [[false,false,false],[false,false,false],[false,false,false]];
      var layout = PipLayouts[n] || [];
      for (var i = 0; i < layout.length; i++) cells[layout[i][0]][layout[i][1]] = true;
      for (var r = 0; r < 3; r++) for (var c = 0; c < 3; c++) html += cells[r][c] ? '<div class="pip"></div>' : '<div></div>';
      return html + '</div>';
    }

    function renderDominoTile(a, b, orient, extraClass) {
      orient = orient || 'h'; extraClass = extraClass || '';
      var isH = orient === 'h';
      var cls = 'dtile ' + (isH ? 'dtile-h' : 'dtile-v') + ' ' + extraClass;
      var div = isH ? '<div class="dtile-div-h"></div>' : '<div class="dtile-div-v"></div>';
      return '<div class="' + cls + '"><div class="dtile-half">' + renderPips(a) + '</div>' + div + '<div class="dtile-half">' + renderPips(b) + '</div></div>';
    }

    function renderHandTile(a, b) {
      return '<div class="dtile-hand-tile dtile-v"><div class="dtile-half">' + renderPips(a) + '</div><div class="dtile-div-v"></div><div class="dtile-half">' + renderPips(b) + '</div></div>';
    }

    // ════════════════════════════════════════
    // PHANTOM WALLET
    // ════════════════════════════════════════
    var PhantomWallet = (function() {
      var provider = null;
      var publicKey = null;
      var network = 'mainnet-beta';

      function getProvider() {
        if (window.solana && window.solana.isPhantom) return window.solana;
        if (window.phantom && window.phantom.solana && window.phantom.solana.isPhantom) return window.phantom.solana;
        return null;
      }

      async function connect() {
        provider = getProvider();
        if (!provider) throw new Error('Phantom wallet not found. Please install it from phantom.app');
        var resp = await provider.connect({ onlyIfTrusted: false });
        publicKey = resp.publicKey.toString();
        return publicKey;
      }

      function disconnect() {
        if (provider) try { provider.disconnect(); } catch(_){}
        publicKey = null;
        provider = null;
      }

      function getPublicKey() { return publicKey; }
      function getProviderRef() { return provider; }
      function getNetwork() { return network; }
      function setNetwork(n) { network = n; }

      function getRpcUrl() {
        if (network === 'devnet') return 'https://api.devnet.solana.com';
        if (network === 'testnet') return 'https://api.testnet.solana.com';
        return 'https://solana-rpc.publicnode.com';
      }

      function shortenAddress(addr) {
        if (!addr) return '';
        return addr.length <= 12 ? addr : addr.slice(0, 6) + '...' + addr.slice(-4);
      }

      return { connect: connect, disconnect: disconnect, getPublicKey: getPublicKey, getProvider: getProviderRef, shortenAddress: shortenAddress, getRpcUrl: getRpcUrl, getNetwork: getNetwork, setNetwork: setNetwork };
    })();

    // ════════════════════════════════════════
    // DOMINO UI — Plato exact replica
    // ════════════════════════════════════════
    var DominoUI = (function() {
      var selectedTileIndex = null;
      var sendActionFn = null;
      var lastState = null;
      var TW = 28, GAP = 0;
      var timerInterval = null;
      var menuOpen = false;

      function startTimer(state) {
        stopTimer();
        if (state.roundOver || state.gameOver) return;
        var remaining = state.turnRemainingMs || 15000;
        var total = state.turnTimeMs || 15000;
        var barEl = document.querySelector('.domino-timer-fill');
        if (!barEl) return;

        var start = Date.now();
        function tick() {
          var elapsed = Date.now() - start;
          var left = Math.max(0, remaining - elapsed);
          var pct = (left / total) * 100;
          barEl.style.width = pct + '%';
          barEl.className = 'domino-timer-fill ' + (pct > 50 ? 'green' : pct > 25 ? 'yellow' : 'red');
          if (left > 0) timerInterval = requestAnimationFrame(tick);
        }
        tick();
      }
      function stopTimer() { if (timerInterval) { cancelAnimationFrame(timerInterval); timerInterval = null; } }

      function render(state, sendAction, gameData) {
        lastState = state; sendActionFn = sendAction;
        var area = document.getElementById('game-area');
        var controls = document.getElementById('game-controls');
        var board = state.board, hand = state.hand;
        var oppCount = state.opponentTileCount, boneCount = state.boneyardCount;
        var isMyTurn = state.isMyTurn;
        var oppName = (gameData && gameData.players) ? gameData.players[1 - state.playerIndex].username : 'Opponent';
        var myName = (gameData && gameData.players) ? gameData.players[state.playerIndex].username : 'You';
        var scores = state.scores || [0, 0];
        var target = state.targetScore || 50;
        var myScore = scores[state.playerIndex];
        var oppScore = scores[1 - state.playerIndex];

        var h = '<div class="domino-screen">';

        h += '<div class="domino-opp-bar">';
        h += '<button class="back-btn" onclick="DominoUI.quit()">&#8592;</button>';
        h += '<div class="domino-opp-center"><div class="domino-opp-top-row">';
        h += '<div class="domino-avatar">' + (oppName ? oppName.charAt(0).toUpperCase() : 'O') + '</div>';
        h += '<span class="domino-score-big">' + oppScore + '/' + target + '</span>';
        h += '</div><div class="domino-name-row"><div class="domino-online-dot"></div>';
        h += '<span class="domino-username">' + oppName + '</span></div></div>';
        h += '<div style="position:relative;"><button class="domino-menu-btn" onclick="DominoUI.toggleMenu(event)">&#8942;</button>';
        h += '<div class="domino-dropdown' + (menuOpen ? ' open' : '') + '">';
        h += '<button class="domino-dropdown-item danger" onclick="DominoUI.resign(event)">Resign</button>';
        h += '</div></div></div>';

        h += '<div class="domino-opp-tiles">';
        for (var i = 0; i < oppCount; i++) h += '<div class="domino-tile-back"></div>';
        h += '</div>';

        var remaining = state.turnRemainingMs || 0;
        var total = state.turnTimeMs || 15000;
        var pct = (remaining / total) * 100;
        var timerCls = pct > 50 ? 'green' : pct > 25 ? 'yellow' : 'red';
        h += '<div class="domino-timer-bar"><div class="domino-timer-fill ' + timerCls + '" style="width:' + pct + '%;"></div></div>';

        h += '<div class="domino-board-area"><div class="domino-board-inner">';
        if (board.length === 0) h += '<span class="domino-chain-empty">Place the first tile!</span>';
        else h += renderSnakeChain(board);
        h += '</div>';

        if (boneCount > 0) {
          h += '<div class="domino-boneyard"><div class="domino-boneyard-stack">';
          var cards = Math.min(boneCount, 4);
          for (var b = 0; b < cards; b++) {
            h += '<div class="domino-boneyard-card" style="top:' + (b * 2) + 'px;left:' + (b * 1) + 'px;"></div>';
          }
          h += '</div><span class="domino-boneyard-count">' + boneCount + '</span></div>';
        }
        h += '</div>';

        if (state.roundOver && !state.gameOver) {
          h += '<div style="position:absolute;inset:0;background:rgba(0,0,0,0.75);display:flex;align-items:center;justify-content:center;z-index:50;">';
          h += '<div style="background:#1e3a8a;border:2px solid #3b82f6;border-radius:16px;padding:1.5rem 2rem;text-align:center;max-width:320px;width:90%;color:#fff;">';
          h += '<h3 style="font-size:1.3rem;margin-bottom:0.8rem;color:#fbbf24;">Round ' + (state.round || 1) + ' Complete</h3>';
          var rwIdx = state.roundWinner;
          if (rwIdx !== null) {
            var rwName = (rwIdx === state.playerIndex) ? myName : oppName;
            h += '<p style="margin-bottom:0.5rem;">' + rwName + ' wins the round!</p>';
            h += '<p style="color:#9ca3af;font-size:0.85rem;margin-bottom:0.3rem;">Pip counts: You ' + (state.pipCounts ? state.pipCounts[state.playerIndex] : 0) + ' &mdash; ' + oppName + ' ' + (state.pipCounts ? state.pipCounts[1 - state.playerIndex] : 0) + '</p>';
            h += '<p style="color:#22c55e;font-size:1.1rem;font-weight:700;">+' + (state.roundPoints || 0) + ' points to ' + rwName + '</p>';
          } else {
            h += '<p>Tie &mdash; no points awarded</p>';
          }
          h += '<p style="margin-top:0.8rem;color:#93c5fd;font-size:0.9rem;">Score: You ' + myScore + ' &mdash; ' + oppName + ' ' + oppScore + '</p>';
          h += '<button onclick="DominoUI.nextRound()" style="margin-top:1rem;background:#22c55e;color:#fff;border:none;border-radius:10px;padding:0.7rem 2rem;font-size:1rem;font-weight:700;cursor:pointer;font-family:inherit;">Next Round</button>';
          h += '</div></div>';
        }

        h += '<div class="domino-my-hand">';
        for (var j = 0; j < hand.length; j++) {
          var sel = j === selectedTileIndex ? ' selected' : '';
          h += '<div class="domino-hand-wrap' + sel + '" onclick="DominoUI.selectTile(' + j + ')">';
          h += renderHandTile(hand[j][0], hand[j][1]);
          h += '</div>';
        }
        h += '</div>';

        h += '<div class="domino-actions">';
        if (isMyTurn && !state.roundOver) {
          if (selectedTileIndex !== null && hand[selectedTileIndex]) {
            var st = hand[selectedTileIndex];
            if (board.length === 0) {
              h += '<button class="side-btn" onclick="DominoUI.playTile(\'right\')">Play Tile</button>';
            } else {
              var mL = st[0] === state.boardLeft || st[1] === state.boardLeft;
              var mR = st[0] === state.boardRight || st[1] === state.boardRight;
              if (mL && mR && state.boardLeft !== state.boardRight) {
                h += '<button class="side-btn" onclick="DominoUI.playTile(\'left\')">&#9664; Left</button>';
                h += '<button class="side-btn" onclick="DominoUI.playTile(\'right\')">Right &#9654;</button>';
              } else if (mL) {
                h += '<button class="side-btn" onclick="DominoUI.playTile(\'left\')">&#9664; Left</button>';
              } else if (mR) {
                h += '<button class="side-btn" onclick="DominoUI.playTile(\'right\')">Right &#9654;</button>';
              } else {
                h += '<span style="color:#fca5a5;font-size:0.8rem;">Doesn\'t match</span>';
              }
            }
          }
        }
        h += '</div>';

        h += '<div class="domino-my-bar">';
        h += '<div class="domino-my-top-row">';
        h += '<div class="domino-avatar my">' + (myName ? myName.charAt(0).toUpperCase() : 'Y') + '</div>';
        h += '<span class="domino-score-big">' + myScore + '/' + target + '</span>';
        h += '</div>';
        h += '<div class="domino-name-row"><div class="domino-online-dot"></div>';
        h += '<span class="domino-username">' + myName + '</span></div>';
        if (!state.roundOver) {
          var pillCls = isMyTurn ? 'active' : 'waiting';
          var pillTxt = isMyTurn ? 'Your Turn' : 'Opponent\'s Turn';
          h += '<div class="domino-turn-pill ' + pillCls + '">' + pillTxt + '</div>';
        }
        h += '</div></div>';

        area.innerHTML = h;
        controls.innerHTML = ''; controls.style.display = 'none';
        if (!state.roundOver && !state.gameOver) startTimer(state);

        if (isMyTurn && !state.roundOver && !state.gameOver && !state.canPlay && state.canDraw) {
          setTimeout(function() { autoDraw(); }, 400);
        }
      }

      function renderSnakeChain(board) {
        var sw = window.innerWidth || 400;
        var TH = sw <= 380 ? 18 : sw <= 480 ? 20 : 28;
        var hW = TH * 2 + 1;
        var hH = TH + 2;
        var vW = TH + 2;
        var vH = TH * 2 + 1;
        var GAP = 1;
        var vOff = Math.round((vH - hH) / 2);

        var screenW = (window.innerWidth || 400);
        var boardW = screenW - 60;

        var positions = [];
        var cx = 0, cy = 0;
        var dir = 1;
        var rowUsed = 0;

        for (var i = 0; i < board.length; i++) {
          var t = board[i], dbl = t[0] === t[1];
          var tw = dbl ? vW : hW;

          var needsTurn = false;
          if (i < board.length - 1 && rowUsed > 0) {
            if (rowUsed + tw + GAP > boardW) {
              needsTurn = true;
            } else {
              var nDbl = board[i + 1][0] === board[i + 1][1];
              var nTw = nDbl ? vW : hW;
              if (rowUsed + tw + GAP + nTw + GAP > boardW) {
                needsTurn = true;
              }
            }
          }

          if (needsTurn) {
            var ty = cy - vOff;
            var tx;
            if (dir === 1) {
              tx = cx;
              positions.push({ a: t[0], b: t[1], x: tx, y: ty, o: 'v', d: 0 });
              cx = tx + vW;
            } else {
              tx = cx - vW;
              positions.push({ a: t[0], b: t[1], x: tx, y: ty, o: 'v', d: 0 });
              cx = tx;
            }
            cy = ty + vH + 6;
            dir = -dir;
            rowUsed = 0;
            continue;
          }

          if (dbl) {
            var dy = cy - vOff;
            if (dir === 1) {
              positions.push({ a: t[0], b: t[1], x: cx, y: dy, o: 'v', d: dir });
              cx += vW + GAP;
            } else {
              positions.push({ a: t[0], b: t[1], x: cx - vW, y: dy, o: 'v', d: dir });
              cx -= vW + GAP;
            }
          } else {
            if (dir === 1) {
              positions.push({ a: t[0], b: t[1], x: cx, y: cy, o: 'h', d: dir });
              cx += hW + GAP;
            } else {
              positions.push({ a: t[0], b: t[1], x: cx - hW, y: cy, o: 'h', d: dir });
              cx -= hW + GAP;
            }
          }
          rowUsed += tw + GAP;
        }

        var mnx = 1e9, mxx = -1e9, mny = 1e9, mxy = -1e9;
        for (var p = 0; p < positions.length; p++) {
          var q = positions[p];
          var pw = q.o === 'h' ? hW : vW;
          var ph = q.o === 'h' ? hH : vH;
          if (q.x < mnx) mnx = q.x;
          if (q.x + pw > mxx) mxx = q.x + pw;
          if (q.y < mny) mny = q.y;
          if (q.y + ph > mxy) mxy = q.y + ph;
        }
        var cw = mxx - mnx + 6, ch = mxy - mny + 6;
        var html = '<div class="domino-board-canvas" style="width:' + cw + 'px;height:' + ch + 'px;">';
        for (var k = 0; k < positions.length; k++) {
          var tp = positions[k];
          var pa = tp.a, pb = tp.b;
          if (tp.d === -1 && tp.o === 'h') { pa = tp.b; pb = tp.a; }
          html += '<div class="dtile-board" style="left:' + (tp.x - mnx + 3) + 'px;top:' + (tp.y - mny + 3) + 'px;">';
          html += renderDominoTile(pa, pb, tp.o, '');
          html += '</div>';
        }
        return html + '</div>';
      }

      function selectTile(idx) {
        selectedTileIndex = selectedTileIndex === idx ? null : idx;
        if (lastState && sendActionFn) render(lastState, sendActionFn, DominoUI._gameData);
      }
      function playTile(side) {
        if (selectedTileIndex === null || !sendActionFn) return;
        sendActionFn({ type: 'play', tileIndex: selectedTileIndex, side: side });
        selectedTileIndex = null;
      }
      function autoDraw() { if (sendActionFn) sendActionFn({ type: 'auto_draw' }); }
      function nextRound() { if (sendActionFn) sendActionFn({ type: 'next_round' }); selectedTileIndex = null; menuOpen = false; }
      function quit() { if (confirm('Leave the game? You will forfeit.')) window.location.reload(); }
      function resign(e) {
        if (e) { e.stopPropagation(); e.preventDefault(); }
        menuOpen = false;
        if (confirm('Are you sure you want to resign? You will lose the game.')) {
          if (sendActionFn) sendActionFn({ type: 'resign' });
        }
      }
      function toggleMenu(e) {
        if (e) { e.stopPropagation(); e.preventDefault(); }
        menuOpen = !menuOpen;
        var dd = document.querySelector('.domino-dropdown');
        if (dd) dd.classList.toggle('open', menuOpen);
      }

      document.addEventListener('click', function(e) {
        if (menuOpen && !e.target.closest('.domino-menu-btn')) {
          menuOpen = false;
          var dd = document.querySelector('.domino-dropdown');
          if (dd) dd.classList.remove('open');
        }
      });

      return {
        render: function(state, sendAction, gd) { DominoUI._gameData = gd; render(state, sendAction, gd); },
        selectTile: selectTile, playTile: playTile, autoDraw: autoDraw, nextRound: nextRound,
        quit: quit, resign: resign, toggleMenu: toggleMenu,
        _gameData: null
      };
    })();

    // ════════════════════════════════════════
    // TIC TAC TOE UI
    // ════════════════════════════════════════
    var TicTacToeUI = (function() {
      var sendActionFn = null;

      function render(state, sendAction) {
        sendActionFn = sendAction;
        var area = document.getElementById('game-area');
        var board = state.board, size = state.size || 3, symbol = state.symbol;
        var winLen = state.winLength || (size <= 3 ? 3 : 4);
        var cellSize = size <= 3 ? 100 : (size <= 5 ? 70 : 54);
        var fontSize = size <= 3 ? '2.5rem' : (size <= 5 ? '1.6rem' : '1.2rem');

        var html = '<div><p style="text-align:center;margin-bottom:0.8rem;color:#9ca3af;">You are <strong style="color:' +
          (symbol === 'X' ? '#a78bfa' : '#f59e0b') + ';font-size:1.3rem;">' + symbol + '</strong> &mdash; get <strong>' + winLen + '</strong> in a row to win</p>';
        html += '<div class="ttt-grid" style="grid-template-columns:repeat(' + size + ',' + cellSize + 'px);grid-template-rows:repeat(' + size + ',' + cellSize + 'px);">';
        for (var i = 0; i < board.length; i++) {
          var val = board[i], cls = 'ttt-cell', content = '';
          if (val === 0) { cls += ' x taken'; content = 'X'; }
          else if (val === 1) { cls += ' o taken'; content = 'O'; }
          var onclick = val === null && state.isMyTurn ? ' onclick="TicTacToeUI.placeAt(' + i + ')"' : '';
          html += '<div class="' + cls + '" style="font-size:' + fontSize + ';"' + onclick + '>' + content + '</div>';
        }
        html += '</div></div>';
        area.innerHTML = html;

        var controls = document.getElementById('game-controls');
        controls.innerHTML = state.isMyTurn
          ? '<p style="text-align:center;color:#10b981;font-weight:600;">Click a cell to place your mark!</p>'
          : '<p style="text-align:center;color:#9ca3af;">Waiting for opponent to play...</p>';
      }

      function placeAt(cell) { if (sendActionFn) sendActionFn({ type: 'place', cell: cell }); }
      return { render: render, placeAt: placeAt };
    })();

    // ════════════════════════════════════════
    // MAIN APP
    // ════════════════════════════════════════
    var App = (function() {
      var socket = null;
      var currentGame = null;
      var myPlayerIndex = null;
      var gameState = null;
      var currentGameData = null;
      var currentBalance = 0;
      var escrowAddress = null;
      var solConnection = null;

      function showScreen(name) {
        var all = ['connect','lobby','waiting','game'];
        for (var i = 0; i < all.length; i++) document.getElementById('screen-' + all[i]).classList.remove('active');
        document.getElementById('screen-' + name).classList.add('active');
      }

      function updateBalanceUI(bal) {
        currentBalance = bal;
        document.getElementById('balance-amount').textContent = bal.toFixed(3);
        document.getElementById('topbar-balance').textContent = bal.toFixed(3) + ' SOL';
      }

      async function refreshBalance() {
        var walletAddr = PhantomWallet.getPublicKey();
        if (!walletAddr) return;

        var rpcUrl = PhantomWallet.getRpcUrl();
        console.log('Fetching balance from:', rpcUrl, 'for:', walletAddr);

        try {
          var body = JSON.stringify({
            jsonrpc: '2.0', id: 1,
            method: 'getBalance',
            params: [walletAddr]
          });
          var resp = await fetch(rpcUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: body
          });
          var json = await resp.json();
          if (json.error) throw new Error(json.error.message || 'RPC error');
          var lamports = json.result.value;
          var sol = lamports / 1000000000;
          updateBalanceUI(sol);
        } catch (e) {
          console.error('Balance fetch error:', e);
          showToast('Balance fetch failed — try Refresh', 'error');
        }
      }

      function init() {
        setupConnectScreen();
        setupLobbyScreen();
        setupWaitingScreen();
        setupGameOverlay();
      }

      function connectToServer() {
        var walletAddress = PhantomWallet.getPublicKey();
        try { socket = io({ reconnectionAttempts: 5, timeout: 10000 }); } catch(e) { showToast('Cannot connect to server', 'error'); return; }

        socket.on('connect', function() {
          socket.emit('register', { walletAddress: walletAddress, displayName: PhantomWallet.shortenAddress(walletAddress) });
        });

        socket.on('connect_error', function() { showToast('Server connection failed — retrying...', 'error'); });

        socket.on('registered', function(data) {
          escrowAddress = data.escrowAddress;
          document.getElementById('connected-wallet-addr').textContent = data.walletAddress;
          document.getElementById('wallet-display').textContent = PhantomWallet.shortenAddress(data.walletAddress);
          showScreen('lobby');
          refreshBalance();
        });

        socket.on('balance_update', function(data) {
          if (data.refreshWallet) refreshBalance();
          if (data.msg) showToast(data.msg, 'info');
        });

        socket.on('waiting', function(data) {
          document.getElementById('waiting-info').textContent = data.gameType.toUpperCase() + ' — ' + data.betAmount + ' SOL bet';
          showScreen('waiting');
        });

        socket.on('lobby_update', updateLobby);
        socket.on('game_start', onGameStart);
        socket.on('game_state', onGameState);
        socket.on('game_over', onGameOver);
        socket.on('search_cancelled', function() { showScreen('lobby'); });
        socket.on('error_msg', function(d) { showToast(d.msg, 'error'); });
        socket.on('disconnect', function() { showToast('Disconnected from server', 'error'); });
      }

      function setupConnectScreen() {
        var phantomBtn = document.getElementById('btn-connect-phantom');
        var errEl = document.getElementById('connect-error');

        phantomBtn.addEventListener('click', async function() {
          phantomBtn.disabled = true;
          phantomBtn.textContent = 'Connecting...';
          errEl.style.display = 'none';
          try {
            await PhantomWallet.connect();
            connectToServer();
          } catch (err) {
            errEl.textContent = err.message || 'Failed to connect wallet';
            errEl.style.display = 'block';
            phantomBtn.disabled = false;
            phantomBtn.innerHTML = '<img src="https://phantom.app/img/phantom-icon-purple.png" alt="" onerror="this.style.display=\'none\'" /> Connect Phantom Wallet';
          }
        });
      }

      function setupLobbyScreen() {
        // Network selector
        document.getElementById('network-select').addEventListener('change', function() {
          var net = this.value;
          PhantomWallet.setNetwork(net);
          var indicator = document.getElementById('network-indicator');
          if (net === 'mainnet-beta') { indicator.textContent = 'Mainnet'; indicator.style.background = 'var(--green)'; }
          else if (net === 'devnet') { indicator.textContent = 'Devnet'; indicator.style.background = 'var(--gold)'; }
          else { indicator.textContent = 'Testnet'; indicator.style.background = 'var(--accent)'; }
          solConnection = null;
          refreshBalance();
        });

        // Refresh balance
        document.getElementById('btn-refresh-balance').addEventListener('click', function() {
          refreshBalance();
          showToast('Refreshing balance...', 'info');
        });

        // Copy wallet address
        document.getElementById('connected-wallet-addr').addEventListener('click', function() {
          if (navigator.clipboard) navigator.clipboard.writeText(this.textContent).then(function() { showToast('Address copied!', 'info'); });
        });

        // Game cards — bet by signing a Phantom transfer to escrow
        var cards = document.querySelectorAll('.game-card');
        for (var ci = 0; ci < cards.length; ci++) {
          (function(card) {
            var gridBtns = card.querySelectorAll('.grid-btn');
            for (var gi = 0; gi < gridBtns.length; gi++) {
              gridBtns[gi].addEventListener('click', function() {
                for (var x = 0; x < gridBtns.length; x++) gridBtns[x].classList.remove('active');
                this.classList.add('active');
              });
            }
            card.querySelector('.btn-play').addEventListener('click', async function() {
              var gameType = card.dataset.game;
              var betInput = card.querySelector('.bet-amount-input');
              var betAmount = parseFloat(betInput.value);
              if (!betAmount || betAmount <= 0) { showToast('Enter a bet amount', 'error'); betInput.focus(); return; }
              if (betAmount > currentBalance) { showToast('Not enough SOL in your wallet!', 'error'); return; }
              if (!escrowAddress) { showToast('Server not ready, try again', 'error'); return; }

              var btn = this;
              btn.disabled = true;
              btn.textContent = 'Confirm in Phantom...';

              try {
                var provider = PhantomWallet.getProvider();
                var web3 = window.solanaWeb3;
                solConnection = new web3.Connection(PhantomWallet.getRpcUrl(), 'confirmed');

                var fromPubkey = provider.publicKey;
                var toPubkey = new web3.PublicKey(escrowAddress);
                var lamports = Math.floor(betAmount * web3.LAMPORTS_PER_SOL);

                var transaction = new web3.Transaction().add(
                  web3.SystemProgram.transfer({
                    fromPubkey: fromPubkey,
                    toPubkey: toPubkey,
                    lamports: lamports,
                  })
                );
                transaction.feePayer = fromPubkey;
                var bh = await solConnection.getLatestBlockhash('confirmed');
                transaction.recentBlockhash = bh.blockhash;

                var signed = await provider.signTransaction(transaction);
                btn.textContent = 'Sending bet...';

                var signature = await solConnection.sendRawTransaction(signed.serialize());
                btn.textContent = 'Confirming...';

                await solConnection.confirmTransaction(signature, 'confirmed');

                var payload = { gameType: gameType, betAmount: betAmount, txSignature: signature };
                var activeGrid = card.querySelector('.grid-btn.active');
                if (activeGrid) payload.gridSize = parseInt(activeGrid.dataset.grid);

                socket.emit('find_match', payload);
                btn.disabled = false;
                btn.textContent = 'Find Match';
                refreshBalance();
              } catch (err) {
                showToast(err.message || 'Transaction cancelled', 'error');
                btn.disabled = false;
                btn.textContent = 'Find Match';
              }
            });
          })(cards[ci]);
        }
      }

      function updateLobby(data) {
        document.getElementById('online-count').textContent = data.onlineCount + ' online';
        var waitList = document.getElementById('waiting-list');
        waitList.innerHTML = data.waiting.length === 0
          ? '<li class="empty-msg">No one waiting</li>'
          : data.waiting.map(function(w) { return '<li><span>' + w.username + ' — ' + w.gameType + '</span><span>' + w.betAmount + ' SOL</span></li>'; }).join('');
        var activeList = document.getElementById('active-list');
        activeList.innerHTML = data.activeGames.length === 0
          ? '<li class="empty-msg">No active games</li>'
          : data.activeGames.map(function(g) { return '<li><span>' + g.players.join(' vs ') + '</span><span>' + g.gameType + ' — ' + g.betAmount + ' SOL</span></li>'; }).join('');
      }

      function setupWaitingScreen() {
        document.getElementById('btn-cancel-search').addEventListener('click', function() { socket.emit('cancel_search'); });
      }

      function onGameStart(data) {
        currentGame = data.gameType;
        myPlayerIndex = data.playerIndex;
        currentGameData = data;

        var topbar = document.querySelector('.game-topbar');
        if (data.gameType === 'domino') {
          topbar.style.display = 'none';
        } else {
          topbar.style.display = '';
          document.getElementById('game-type-label').textContent = data.gameType.toUpperCase();
          document.getElementById('game-bet-label').textContent = data.betAmount + ' SOL';
          document.getElementById('player1-label').textContent = data.players[0].username;
          document.getElementById('player2-label').textContent = data.players[1].username;
          document.getElementById('player1-label').style.color = data.playerIndex === 0 ? '#8b5cf6' : '';
          document.getElementById('player2-label').style.color = data.playerIndex === 1 ? '#8b5cf6' : '';
        }
        showScreen('game');
      }

      function onGameState(state) {
        gameState = state;

        if (state.gameType === 'domino') {
          DominoUI.render(state, sendAction, currentGameData);
        } else {
          var turnEl = document.getElementById('turn-indicator');
          turnEl.textContent = state.isMyTurn ? 'YOUR TURN' : "OPPONENT'S TURN";
          turnEl.className = 'turn-indicator ' + (state.isMyTurn ? 'my-turn' : 'their-turn');
          if (state.gameType === 'tictactoe') TicTacToeUI.render(state, sendAction);
        }
      }

      function sendAction(action) { if (socket) socket.emit('game_action', action); }

      function onGameOver(data) {
        var overlay = document.getElementById('overlay-gameover');
        var title = document.getElementById('gameover-title');
        var detail = document.getElementById('gameover-detail');
        var payout = document.getElementById('gameover-payout');
        if (data.isDraw) {
          title.textContent = 'DRAW!'; title.style.color = '#f59e0b';
          detail.textContent = 'Nobody wins — bets returned.'; payout.textContent = '';
        } else {
          var iWon = data.winnerWallet === PhantomWallet.getPublicKey();
          title.textContent = iWon ? 'YOU WIN!' : 'YOU LOSE';
          title.style.color = iWon ? '#10b981' : '#ef4444';
          detail.textContent = data.reason ? data.winner + ' wins — ' + data.reason : data.winner + ' wins!';
          payout.textContent = iWon ? '+' + data.payout.toFixed(3) + ' SOL' : '';
        }
        overlay.classList.remove('hidden');
      }

      function setupGameOverlay() {
        document.getElementById('btn-back-lobby').addEventListener('click', function() {
          document.getElementById('overlay-gameover').classList.add('hidden');
          currentGame = null; gameState = null; currentGameData = null;
          document.querySelector('.game-topbar').style.display = '';
          document.getElementById('game-controls').style.display = '';
          showScreen('lobby');
          if (socket) socket.emit('get_lobby');
          refreshBalance();
        });
      }

      function showToast(msg, type) {
        type = type || 'info';
        var t = document.createElement('div');
        t.style.cssText = 'position:fixed;bottom:1.5rem;right:1.5rem;z-index:9999;background:' + (type === 'error' ? '#ef4444' : '#8b5cf6') + ';color:#fff;padding:0.8rem 1.2rem;border-radius:8px;font-size:0.9rem;font-weight:600;box-shadow:0 4px 20px rgba(0,0,0,0.3);';
        t.textContent = msg; document.body.appendChild(t);
        setTimeout(function() { t.remove(); }, 3500);
      }

      document.addEventListener('DOMContentLoaded', init);
      return { showScreen: showScreen, sendAction: sendAction };
    })();

  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/sw.js').catch(function() {});
      });
    }
  </script>
</body>
</html>
